<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WatchNow - Coleccionistas</title>
    
    <!-- Librerías de Estilos y Componentes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- DISEÑO ROLEX GREEN & CHROME --- */
        :root {
            --bg-rolex: #1A522C;     /* Fondo Verde Rolex */
            --card-rolex: #0B3419;   /* Fondo Oscuro */
            --chrome: #C0C0C0;       /* Plata Brillante */
            --text-dark: #000000;
            --text-light: #FFFFFF;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-rolex);
            color: var(--text-light);
            border: 8px solid var(--chrome); /* Borde Metálico */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .btn-chrome {
            background: linear-gradient(145deg, #e6e6e6, #a0a0a0);
            color: var(--text-dark);
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border: 2px solid #ffffff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }
        .btn-chrome:active {
            transform: scale(0.98);
            background: #a0a0a0;
        }

        .card-luxury {
            background-color: var(--card-rolex);
            border: 2px solid var(--chrome);
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }

        input, textarea, select {
            background-color: rgba(255,255,255,0.1);
            border: 1px solid var(--chrome);
            color: white;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: white;
            box-shadow: 0 0 10px rgba(255,255,255,0.2);
        }

        .hidden { display: none !important; }
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-2 sm:p-4">

    <!-- 1. PANTALLA DE CARGA -->
    <div id="view-loading" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-[#1A522C]">
        <h1 class="text-4xl font-bold text-white mb-4 tracking-widest">WATCHNOW</h1>
        <div class="w-16 h-16 border-4 border-gray-400 border-t-white rounded-full loading-spin"></div>
        <p id="loading-text" class="mt-4 text-gray-300 text-sm">Iniciando sistema...</p>
    </div>

    <!-- 2. ENCABEZADO -->
    <header class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-2">
            <i data-lucide="watch" class="text-gray-300 w-8 h-8"></i>
            <h1 class="text-2xl font-bold italic tracking-tighter">WatchNow</h1>
        </div>
        <button id="btn-logout" class="hidden text-xs underline text-gray-300">Salir</button>
    </header>

    <!-- 3. PANTALLA DE LOGIN -->
    <div id="view-login" class="hidden flex-grow flex flex-col items-center justify-center">
        <div class="card-luxury p-8 rounded-xl w-full max-w-sm text-center">
            <h2 class="text-xl font-bold mb-6 text-[#C0C0C0]">ACCESO COLECCIONISTAS</h2>
            
            <div class="space-y-4">
                <!-- Google Auth está desactivado en Canvas, pero se deja el botón para UX -->
                <button onclick="showModal('Autenticación', 'La autenticación de terceros (Google) no está soportada en este entorno.', false)" class="btn-chrome w-full py-3 rounded flex justify-center items-center gap-2 opacity-60 cursor-not-allowed">
                    <i data-lucide="globe"></i> Iniciar con Google (No disponible)
                </button>
                
                <div class="relative py-2">
                    <div class="absolute inset-0 flex items-center"><span class="w-full border-t border-gray-600"></span></div>
                    <div class="relative flex justify-center"><span class="bg-[#0B3419] px-2 text-xs text-gray-400">O</span></div>
                </div>

                <button onclick="handleAuth('anonymous')" class="btn-chrome w-full py-3 rounded text-sm opacity-90">
                    Entrar como Invitado
                </button>
            </div>
            <p id="login-error" class="mt-4 text-red-400 text-xs hidden"></p>
        </div>
    </div>

    <!-- 4. PANTALLA PRINCIPAL (APP) -->
    <main id="view-app" class="hidden flex-grow flex flex-col max-w-2xl mx-auto w-full">
        
        <!-- Tarjeta de Usuario -->
        <div class="mb-6 text-center">
            <p class="text-xs text-gray-400">ID DE SESIÓN (PARA COLECCIÓN)</p>
            <p id="user-id-display" class="font-mono text-[#C0C0C0] text-sm break-all">...</p>
        </div>

        <!-- Menú Principal -->
        <div class="grid grid-cols-2 gap-4 mb-8">
            <!-- Botón Escanear -->
            <button onclick="document.getElementById('file-input').click()" class="card-luxury p-6 rounded-xl flex flex-col items-center gap-3 hover:bg-[#144020] transition cursor-pointer">
                <div class="bg-[#C0C0C0] text-black p-3 rounded-full">
                    <i data-lucide="camera" class="w-8 h-8"></i>
                </div>
                <span class="font-bold text-[#C0C0C0]">ESCANEAR RELOJ</span>
                <input type="file" id="file-input" accept="image/*" class="hidden">
            </button>

            <!-- Botón Colección -->
            <button onclick="showSection('collection')" class="card-luxury p-6 rounded-xl flex flex-col items-center gap-3 hover:bg-[#144020] transition cursor-pointer">
                <div class="bg-[#144020] text-[#C0C0C0] p-3 rounded-full border border-[#C0C0C0]">
                    <i data-lucide="library" class="w-8 h-8"></i>
                </div>
                <span class="font-bold text-gray-400">MI COLECCIÓN</span>
            </button>
        </div>

        <!-- Sección: Resultados de IA (Oculta por defecto) -->
        <div id="scan-result" class="hidden card-luxury p-6 rounded-xl mb-8 animate-fade-in">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-xl font-bold text-[#C0C0C0]">ANÁLISIS DE IA</h3>
                <button onclick="closeScan()" class="text-gray-400"><i data-lucide="x"></i></button>
            </div>
            
            <div class="flex gap-4 mb-4">
                <img id="scan-img" class="w-24 h-24 object-cover rounded border border-gray-500" src="https://placehold.co/100x100/1A522C/FFFFFF?text=Reloj">
                <div>
                    <h4 id="scan-title" class="font-bold text-lg text-white">Detectando...</h4>
                    <p id="scan-desc" class="text-xs text-gray-300 mt-1">Analizando imagen...</p>
                </div>
            </div>

            <div id="scan-data" class="space-y-2 text-sm text-gray-300 mb-4">
                <!-- Datos dinámicos -->
            </div>

            <button id="btn-save-watch" onclick="saveCurrentWatch()" class="btn-chrome w-full py-2 rounded flex justify-center items-center gap-2" disabled>
                <i data-lucide="save" class="w-4 h-4"></i> GUARDAR EN COLECCIÓN
            </button>
        </div>

        <!-- Sección: Lista de Colección -->
        <div id="collection-list" class="hidden card-luxury p-4 rounded-xl">
            <h3 class="text-lg font-bold text-[#C0C0C0] mb-4 border-b border-gray-600 pb-2">TU CAJA DE RELOJES</h3>
            <div id="watches-container" class="space-y-3 max-h-80 overflow-y-auto">
                <p class="text-center text-gray-500 italic py-4">Tu colección está vacía.</p>
            </div>
            <button onclick="showSection('menu')" class="mt-4 text-center w-full text-xs text-gray-400 underline">Volver al Menú</button>
        </div>

    </main>
    
    <!-- MODAL DE ERROR/MENSAJE -->
    <div id="modal" class="fixed inset-0 z-[60] hidden items-center justify-center bg-black/80 p-4">
        <div class="card-luxury p-6 rounded-xl w-full max-w-sm text-center bg-[#0B3419]">
            <i data-lucide="alert-circle" class="w-12 h-12 text-red-500 mx-auto mb-3"></i>
            <h3 id="modal-title" class="font-bold text-lg text-white mb-2">Error</h3>
            <p id="modal-msg" class="text-sm text-gray-300 mb-6">Mensaje</p>
            <div id="modal-actions" class="flex justify-center gap-3">
                <button id="modal-close-btn" onclick="document.getElementById('modal').classList.add('hidden')" class="btn-chrome px-6 py-2 rounded">CERRAR</button>
                <!-- Botón de Confirmación se inserta aquí dinámicamente -->
            </div>
        </div>
    </div>

    const GEMINI_KEY = "TU_CLAVE_DE_GEMINI_AI_STUDIO"; // o tu clave pegada
        // =================================================================
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        let app, auth, db;
        let currentUser = null;
        let currentWatchData = null;

        // --- FUNCIONES DE UTILIDAD ---
        // Manejo de Modales (Reemplazo de alert/confirm)
        function showModal(title, msg, isConfirmable = false, callback = null) {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMsg = document.getElementById('modal-msg');
            const actionsDiv = document.getElementById('modal-actions');
            const closeBtn = document.getElementById('modal-close-btn');

            modalTitle.innerText = title;
            modalMsg.innerHTML = msg;

            // Limpiar botones de confirmación anteriores
            let confirmBtn = document.getElementById('confirm-action-btn');
            if (confirmBtn) confirmBtn.remove();

            if (isConfirmable && callback) {
                // Configuración para Confirmar
                confirmBtn = document.createElement('button');
                confirmBtn.id = 'confirm-action-btn';
                confirmBtn.className = 'btn-chrome px-4 py-2 rounded text-red-700 font-bold';
                confirmBtn.innerText = 'SÍ, ELIMINAR';
                confirmBtn.onclick = () => {
                    modal.classList.add('hidden');
                    callback();
                };
                actionsDiv.insertBefore(confirmBtn, closeBtn); // Insertar antes del botón Cerrar
                closeBtn.innerText = 'CANCELAR';
            } else {
                closeBtn.innerText = 'CERRAR';
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            lucide.createIcons();
        }

        // --- INICIALIZACIÓN ---
        async function init() {
            try {
                // --- CONFIGURACIÓN DE FIREBASE (USANDO VARIABLES DE ENTORNO) ---
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                let firebaseConfig = {};
                if (typeof __firebase_config !== 'undefined') {
                    firebaseConfig = JSON.parse(__firebase_config);
                }
                
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Verificar clave de Gemini
                if (GEMINI_KEY === "") {
                    showModal("Error de Configuración", "Falta la clave de Gemini. Por favor, edita la variable <code>GEMINI_KEY</code> en la línea 271 del código.");
                    document.getElementById('loading-text').innerText = "Error: Clave Gemini ausente";
                    return;
                }

                document.getElementById('loading-text').innerText = "Autenticando usuario...";

                // Promesa para manejar la autenticación inicial
                const initialAuthPromise = new Promise(async (resolve) => {
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    
                    // Listener para capturar el estado final del usuario
                    const unsubscribe = onAuthStateChanged(auth, (user) => {
                        if (user) {
                            currentUser = user;
                            // Mostrar ID completo para facilitar el debug y uso del path en Firestore
                            document.getElementById('user-id-display').innerText = user.uid;
                            switchView('app');
                            loadCollection();
                            document.getElementById('btn-logout').classList.remove('hidden');
                        } else {
                            currentUser = null;
                            switchView('login');
                            document.getElementById('btn-logout').classList.add('hidden');
                        }
                        document.getElementById('view-loading').classList.add('hidden');
                        unsubscribe(); // Detener el listener
                        resolve();
                    });

                    // Intentar la autenticación con el token custom
                    try {
                        if (token) {
                            await signInWithCustomToken(auth, token);
                        } else {
                            // Si no hay token, iniciamos de forma anónima para obtener un UID
                            await signInAnonymously(auth);
                        }
                    } catch (authError) {
                        console.error("Fallo la autenticación con token custom o anónima:", authError);
                        // El onAuthStateChanged se encargará de llevar al usuario al login
                    }
                });

                await initialAuthPromise;

            } catch (e) {
                showModal("Error Crítico", e.message + "<br><br>Revisa la consola (F12) para más detalles.");
                document.getElementById('loading-text').innerText = "Error crítico";
            }
        }

        // --- MANEJO DE VISTAS ---
        function switchView(viewName) {
            ['view-login', 'view-app'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            lucide.createIcons();
        }

        window.showSection = (section) => {
            if (section === 'collection') {
                document.getElementById('collection-list').classList.remove('hidden');
                document.getElementById('scan-result').classList.add('hidden');
                document.getElementById('collection-list').scrollIntoView({ behavior: 'smooth' });
            } else { // 'menu'
                document.getElementById('collection-list').classList.add('hidden');
                document.getElementById('scan-result').classList.add('hidden');
            }
        };

        window.closeScan = () => {
            document.getElementById('scan-result').classList.add('hidden');
            document.getElementById('file-input').value = '';
            currentWatchData = null; // Limpia los datos
        };

        // --- AUTENTICACIÓN ---
        window.handleAuth = async (method) => {
            try {
                if (method === 'anonymous') {
                    await signInAnonymously(auth);
                } else if (method === 'google') {
                    // Solo para UX, la autenticación de Google no funciona aquí
                    showModal('Autenticación', 'La autenticación de terceros (Google) no está soportada en este entorno.', false);
                }
            } catch (e) {
                showModal("Error de Login", e.message);
            }
        };

        document.getElementById('btn-logout').onclick = () => signOut(auth);

        // --- INTELIGENCIA ARTIFICIAL (GEMINI VISION) ---
        const fileInput = document.getElementById('file-input');
        
        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (GEMINI_KEY === "") {
                showModal("Error de Configuración", "No se puede escanear. La clave <code>GEMINI_KEY</code> está ausente.");
                return;
            }

            // 1. Mostrar UI de carga
            document.getElementById('scan-result').classList.remove('hidden');
            document.getElementById('collection-list').classList.add('hidden');
            document.getElementById('scan-img').src = URL.createObjectURL(file);
            document.getElementById('scan-title').innerText = "Analizando...";
            document.getElementById('scan-desc').innerText = "Contactando a la IA...";
            document.getElementById('scan-data').innerHTML = '';
            document.getElementById('btn-save-watch').disabled = true;
            document.getElementById('scan-result').scrollIntoView({ behavior: 'smooth' });


            // 2. Convertir a Base64
            const reader = new FileReader();
            reader.onload = async () => {
                const base64 = reader.result.split(',')[1];
                await callGemini(base64, file.type);
            };
            reader.readAsDataURL(file);
        });

        async function callGemini(base64, mimeType) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_KEY}`;
            // El prompt solicita un JSON para estructurar la respuesta automáticamente.
            const prompt = `Identifica este reloj en la imagen. Devuelve un objeto JSON. Si no es un reloj o no lo identificas, usa 'Desconocido' o 0 para los valores. El JSON debe tener las siguientes claves: brand (marca), model (modelo exacto o genérico si no se sabe), year (año aprox de fabricación, como string), price_usd (estimado numero sin simbolos, solo el numero, como string), description (breve resumen de 30 palabras).`;

            try {
                // Configuración de la solicitud para Gemini
                const payload = {
                    contents: [{ 
                        parts: [
                            { text: prompt }, 
                            { inlineData: { mimeType, data: base64 } } 
                        ] 
                    }],
                    // Forzamos la respuesta como JSON para facilitar el parsing
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                brand: { type: "STRING" },
                                model: { type: "STRING" },
                                year: { type: "STRING" },
                                price_usd: { type: "STRING" },
                                description: { type: "STRING" }
                            }
                        }
                    }
                };
                
                // Implementación de reintentos con Backoff Exponencial
                const MAX_RETRIES = 5;
                let attempt = 0;
                let response;

                while (attempt < MAX_RETRIES) {
                    try {
                        response = await fetch(url, {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) break; // Éxito, salir del bucle

                        // Si falla, espera y reintenta
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        await new Promise(res => setTimeout(res, delay));
                        attempt++;
                    } catch (e) {
                        if (attempt >= MAX_RETRIES - 1) throw e;
                        const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                        await new Promise(res => setTimeout(res, delay));
                        attempt++;
                    }
                }
                
                if (!response || !response.ok) throw new Error(`Fallo la llamada a la API después de ${MAX_RETRIES} intentos.`);

                const data = await response.json();
                
                // La respuesta estructurada está en content.parts[0].text
                const jsonText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (!jsonText || data.error) {
                     throw new Error(data.error?.message || "La IA no devolvió un análisis. Intenta con una imagen más clara.");
                }
                
                // Parsar el JSON
                currentWatchData = JSON.parse(jsonText);
                
                // Asegurar que price_usd sea un número para el formato
                const price = isNaN(parseFloat(currentWatchData.price_usd)) ? 'N/A' : Number(currentWatchData.price_usd).toLocaleString('es-AR', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 });

                // 3. Mostrar Resultados
                document.getElementById('scan-title').innerText = currentWatchData.brand || "Desconocido";
                document.getElementById('scan-desc').innerText = currentWatchData.model || "Modelo no identificado";
                document.getElementById('scan-data').innerHTML = `
                    <p><strong>Año:</strong> ${currentWatchData.year || 'N/A'}</p>
                    <p><strong>Valor Est.:</strong> ${price}</p>
                    <p class="italic opacity-80 mt-2">${currentWatchData.description || 'Sin descripción.'}</p>
                `;
                document.getElementById('btn-save-watch').disabled = false;

            } catch (e) {
                showModal("Error de IA", `Error al procesar la imagen: ${e.message}`);
                document.getElementById('scan-title').innerText = "Fallo de Análisis";
                document.getElementById('scan-desc').innerText = "Por favor, verifica tu clave Gemini o intenta con otra imagen.";
                document.getElementById('scan-data').innerHTML = '';
                document.getElementById('btn-save-watch').disabled = true;
            }
        }

        // --- FIRESTORE: Guardar y Cargar Colección ---
        window.saveCurrentWatch = async () => {
            if (!currentUser || !currentWatchData) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            try {
                // La colección privada usa el UID: /artifacts/{appId}/users/{userId}/watches
                const collectionPath = `artifacts/${appId}/users/${currentUser.uid}/watches`;
                await addDoc(collection(db, collectionPath), {
                    ...currentWatchData,
                    createdAt: Date.now()
                });
                showModal("Éxito", "Reloj guardado en tu colección.");
                window.closeScan();
                // Forzar la vista a la colección después de guardar
                showSection('collection');
            } catch (e) {
                showModal("Error Guardado", "No se pudo guardar. Asegúrate de tener permisos. " + e.message);
            }
        };

        function loadCollection() {
            if (!currentUser) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // La colección privada usa el UID: /artifacts/{appId}/users/{userId}/watches
            const collectionPath = `artifacts/${appId}/users/${currentUser.uid}/watches`;
            // IMPORTANTE: Evitamos el orderBy para prevenir errores de índices en Firestore
            const q = query(collection(db, collectionPath));
            
            // onSnapshot para actualizaciones en tiempo real
            onSnapshot(q, (snapshot) => {
                const watches = [];
                snapshot.forEach(doc => {
                    watches.push({ id: doc.id, ...doc.data() });
                });

                // Ordenar en memoria por la fecha de creación (descendente)
                watches.sort((a, b) => b.createdAt - a.createdAt);

                const container = document.getElementById('watches-container');
                container.innerHTML = ''; // Limpiar lista

                if (watches.length === 0) {
                    container.innerHTML = '<p class="text-center text-gray-500 italic py-4">Tu colección está vacía.</p>';
                    return;
                }
                
                watches.forEach(w => {
                    const price = isNaN(parseFloat(w.price_usd)) ? 'N/A' : Number(w.price_usd).toLocaleString('es-AR', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 });

                    const div = document.createElement('div');
                    div.className = "bg-black/30 p-3 rounded flex justify-between items-center";
                    div.innerHTML = `
                        <div>
                            <div class="font-bold text-[#C0C0C0]">${w.brand || 'N/A'}</div>
                            <div class="text-xs text-gray-400">${w.model || 'N/A'}</div>
                            <div class="text-xs text-gray-500">${price}</div>
                        </div>
                        <button class="text-red-400 hover:text-red-300 p-1" onclick="deleteWatch('${w.id}')"><i data-lucide="trash-2" class="w-4"></i></button>
                    `;
                    container.appendChild(div);
                });
                lucide.createIcons(); // Re-crear íconos de Lucide
            });
        }

        // Eliminar con un modal de confirmación
        window.deleteWatch = (id) => {
             // 1. Mostrar modal de confirmación
            showModal('Confirmar Eliminación', '¿Estás seguro de que quieres eliminar este reloj de tu colección?', true, () => {
                // Función de callback que se ejecuta si se presiona "SÍ, ELIMINAR"
                performDelete(id);
            });
        };

        async function performDelete(id) {
            if (!currentUser) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
             try {
                // Referencia al documento: /artifacts/{appId}/users/{userId}/watches/{id}
                const docRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/watches`, id);
                await deleteDoc(docRef);
                // El onSnapshot recargará la lista automáticamente
                showModal('Eliminado', 'Reloj eliminado correctamente.');
            } catch (e) {
                showModal('Error al Eliminar', 'No se pudo eliminar el reloj. ' + e.message);
            }
        }

        // Iniciar la aplicación al cargar
        window.onload = init;
        lucide.createIcons();
    </script>
</body>
</html>
