<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WatchNow - Plataforma de Coleccionistas</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente principal Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Fondo oscuro tipo GitHub */
        }
        .container-app {
            max-width: 600px;
            min-height: 100vh;
            padding: 1.5rem;
        }
        .card {
            background-color: #161b22; /* Color de fondo de las tarjetas */
            border: 1px solid #30363d;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #238636;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2ea043;
        }
        .spinner {
            border-top-color: #238636;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #inputImage {
            max-height: 300px;
            object-fit: contain;
            width: 100%;
            border-radius: 0.5rem;
            margin-top: 1rem;
            border: 2px dashed #30363d;
            padding: 10px;
        }
        #fileInput {
            display: none;
        }
        .tab-active {
            border-bottom: 2px solid #238636;
            color: #238636;
        }
        .message-bubble-user {
            background-color: #238636;
            align-self: flex-end;
            margin-left: auto;
        }
        .message-bubble-other {
            background-color: #30363d;
            align-self: flex-start;
        }
        /* Estilos para asegurar que el chat siempre esté abajo al cargar */
        #chatMessages {
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body class="flex justify-center items-start">

    <div class="container-app mx-auto text-white">
        
        <!-- Encabezado de la Aplicación -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-[#238636]" data-key="app_title">WatchNow</h1>
            <p class="text-gray-400 text-sm" data-key="app_subtitle">Identificación, Comunidad y Catálogo de Relojes</p>

            <!-- Selector de Idioma -->
            <div class="mt-2 flex justify-center space-x-2 text-sm">
                <button onclick="setLanguage('es')" class="text-gray-400 hover:text-white transition duration-150 border-b border-transparent data-[active=true]:border-white" data-lang-btn="es">Español</button>
                <span class="text-gray-600">|</span>
                <button onclick="setLanguage('en')" class="text-gray-400 hover:text-white transition duration-150 border-b border-transparent data-[active=true]:border-white" data-lang-btn="en">English</button>
            </div>
            
            <!-- Barra de Navegación principal (Visible solo si está autenticado) -->
            <nav id="mainNav" class="flex justify-between items-center mt-4 card p-3 rounded-lg text-sm hidden">
                <div class="flex space-x-4">
                    <button onclick="setView('analyze')" id="navAnalyze" class="nav-link font-semibold border-b-2 border-transparent hover:border-gray-500 pb-1" data-key="nav_analyze">Análisis IA</button>
                    <button onclick="setView('community')" id="navCommunity" class="nav-link font-semibold border-b-2 border-transparent hover:border-gray-500 pb-1" data-key="nav_community">Comunidad</button>
                </div>
                <div class="flex items-center space-x-3">
                    <span id="currentUserDisplay" class="text-gray-400 italic text-xs"></span>
                    <button onclick="handleSignOut()" class="text-red-400 hover:text-red-500 font-semibold" data-key="nav_signout">Cerrar Sesión</button>
                </div>
            </nav>
        </header>

        <!-- Contenedor Dinámico para las Vistas -->
        <div id="appContainer">
            <!-- Mensaje de carga inicial para evitar FOUC -->
            <div class="text-center py-10 text-gray-500" data-key="loading_app">Cargando aplicación...</div>
        </div>

    </div>

    <!-- MÓDULOS Y LÓGICA PRINCIPAL DE JAVASCRIPT -->
    <script type="module">
        // ===============================================
        // 1. CONFIGURACIÓN E INICIALIZACIÓN DE FIREBASE
        // ===============================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, orderBy, serverTimestamp, setDoc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Variables Globales de Canvas (MANDATORIAS)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicialización de Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // ===============================================
        // 2. ESTADO GLOBAL DE LA APLICACIÓN
        // ===============================================
        let currentView = 'loading'; // 'loading', 'auth', 'analyze', 'community'
        let userId = null;
        let userName = null;
        let isAuthReady = false;
        let currentLang = 'es'; // Idioma por defecto
        let base64Image = null; // Para la función de análisis
        let communityTab = 'catalog'; // 'catalog', 'chat'
        
        // Vision API Config
        // NOTA: Esta clave de API es solo para fines de demostración. Debe ser una clave real con acceso a Vision AI.
        const API_KEY = "AIzaSyAf0on8I9CRYx5uOsGmnWDr81EfHQDRcpw"; 
        const VISION_API_URL = `https://vision.googleapis.com/v1/images:annotate?key=${API_KEY}`;
        
        // ===============================================
        // 3. i18n: TRADUCCIONES
        // ===============================================
        const translations = {
            es: {
                app_title: "WatchNow",
                app_subtitle: "Identificación, Comunidad y Catálogo de Relojes",
                loading_app: "Cargando aplicación...",
                select_image_prompt: "Toca para seleccionar una imagen clara del reloj",
                analyze_button: "Analizar Reloj y Buscar",
                results_title: "Resultados del Análisis",
                ident_ia: "Identificación IA:",
                model_estimated: "Modelo Estimado (Catálogo):",
                caliber: "Calibre / Movimiento:",
                price_range: "Precio Estimado (Rango USD):",
                history_summary: "Resumen Histórico/Detalles:",
                error_upload: "Error: Seleccione un archivo de imagen válido.",
                status_loaded: "Imagen cargada. Lista para analizar.",
                status_analyzing: "Analizando...",
                status_complete: "Análisis completado. Resultados encontrados.",
                nav_analyze: "Análisis IA",
                nav_community: "Comunidad/Mercado",
                nav_signout: "Cerrar Sesión",
                nav_signin: "Iniciar Sesión",
                tab_catalog: "Catálogo",
                tab_chat: "Chat Comunitario",
                chat_title: "Chat de Coleccionistas (Venta/Cambio)",
                chat_placeholder: "Escribe tu mensaje (y propón ventas o cambios)...",
                send_button: "Enviar",
                login_title: "Ingresar a WatchNow",
                login_email: "Correo Electrónico",
                login_password: "Contraseña",
                login_button: "Iniciar Sesión",
                signup_button: "Crear Cuenta",
                login_anon_button: "Continuar como Anónimo",
                error_auth: "Error de autenticación. Intente de nuevo.",
                current_user: "Usuario:",
                user_anon: "Anónimo",
                error_403: "❌ ¡ERROR 403! Acceso Denegado. Verifique la clave de API.",
                catalog_title: "Catálogo de Relojes Comunitario",
                catalog_prompt: "Explora la colección o usa el Análisis IA para identificar un reloj y agregarlo."
            },
            en: {
                app_title: "WatchNow",
                app_subtitle: "Watch Identification, Community & Catalog",
                loading_app: "Loading application...",
                select_image_prompt: "Tap to select a clear image of the watch",
                analyze_button: "Analyze Watch & Search",
                results_title: "Analysis Results",
                ident_ia: "AI Identification:",
                model_estimated: "Estimated Model (Catalog):",
                caliber: "Caliber / Movement:",
                price_range: "Estimated Price (USD Range):",
                history_summary: "History/Details Summary:",
                error_upload: "Error: Please select a valid image file.",
                status_loaded: "Image loaded. Ready for analysis.",
                status_analyzing: "Analyzing...",
                status_complete: "Analysis complete. Results found.",
                nav_analyze: "AI Analysis",
                nav_community: "Community/Market",
                nav_signout: "Sign Out",
                nav_signin: "Sign In",
                tab_catalog: "Catalog",
                tab_chat: "Community Chat",
                chat_title: "Collectors Chat (Buy/Sell/Exchange)",
                chat_placeholder: "Write your message (propose sales or exchanges)...",
                send_button: "Send",
                login_title: "Sign in to WatchNow",
                login_email: "Email Address",
                login_password: "Password",
                login_button: "Sign In",
                signup_button: "Create Account",
                login_anon_button: "Continue as Anonymous",
                error_auth: "Authentication error. Please try again.",
                current_user: "User:",
                user_anon: "Anonymous",
                error_403: "❌ ERROR 403! Access Denied. Check API key.",
                catalog_title: "Community Watch Catalog",
                catalog_prompt: "Explore the collection or use AI Analysis to identify a watch and add it."
            }
        };

        function T(key) {
            return translations[currentLang][key] || key;
        }

        function setLanguage(lang) {
            currentLang = lang;
            // Guardar en localStorage para persistencia (opcional)
            localStorage.setItem('watchnow_lang', lang);
            updateUI();
        }
        
        // Cargar idioma guardado al inicio
        document.addEventListener('DOMContentLoaded', () => {
            const savedLang = localStorage.getItem('watchnow_lang');
            if (savedLang && translations[savedLang]) {
                currentLang = savedLang;
            }
            // Llamada inicial a initAuth para comenzar el ciclo de vida de la app
            initAuth();
            initializeCatalogData();
        });

        // Función para aplicar traducciones a todos los elementos con data-key
        function applyTranslations() {
            document.querySelectorAll('[data-key]').forEach(el => {
                const key = el.getAttribute('data-key');
                el.textContent = T(key);
            });
            // Actualizar placeholders y títulos
            const chatInput = document.getElementById('chatInput');
            if (chatInput) chatInput.placeholder = T('chat_placeholder');
        }

        // ===============================================
        // 4. LÓGICA DE AUTENTICACIÓN
        // ===============================================

        // Inicialización de Auth (usando el token o anónimo)
        async function initAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                // Si falla la inicialización, forzamos la vista de autenticación
                currentView = 'auth';
                isAuthReady = true;
                updateUI();
            }
        }
        
        // Listener que se dispara cuando cambia el estado de autenticación
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                // Si el usuario tiene un displayName, lo usa, si no, usa el email o 'Anónimo'
                userName = user.displayName || (user.email ? user.email.split('@')[0] : T('user_anon'));
                
                // Si estábamos cargando o en auth, vamos a la vista de análisis
                if (currentView === 'loading' || currentView === 'auth') {
                    currentView = 'analyze'; 
                }
            } else {
                userId = null;
                userName = null;
                currentView = 'auth'; // Forzar vista de autenticación
            }
            isAuthReady = true; // El estado de autenticación ya está listo
            updateUI();
        });
        
        // Funciones de control de Auth expuestas globalmente
        window.handleSignIn = async (email, password) => {
            try {
                await signInWithEmailAndPassword(auth, email, password);
                document.getElementById('authError').textContent = ''; // Limpiar error
            } catch (error) {
                document.getElementById('authError').textContent = T('error_auth');
            }
        };

        window.handleSignUp = async (email, password) => {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                // Establecer un nombre de usuario básico (parte del email)
                await updateProfile(userCredential.user, { displayName: email.split('@')[0] });
                document.getElementById('authError').textContent = ''; // Limpiar error
            } catch (error) {
                document.getElementById('authError').textContent = T('error_auth');
            }
        };

        window.handleSignOut = async () => {
            await signOut(auth);
        };

        window.handleAnonSignIn = async () => {
            await signInAnonymously(auth);
        };

        // ===============================================
        // 5. LÓGICA DE FIREBASE FIRESTORE (CATÁLOGO Y CHAT)
        // ===============================================

        // RUTAS DE FIREBASE (Uso de rutas públicas para la comunidad)
        const CHAT_COLLECTION_PATH = `artifacts/${appId}/public/data/chat_messages`;
        const CATALOG_COLLECTION_PATH = `artifacts/${appId}/public/data/watch_catalog`;

        let catalogData = [];
        let unsubscribeCatalog = null;
        let unsubscribeChat = null;

        // Limpiar y configurar el listener del catálogo
        function setupCatalogListener() {
            if (unsubscribeCatalog) unsubscribeCatalog(); // Limpiar listener anterior
            if (!userId) return;

            const q = collection(db, CATALOG_COLLECTION_PATH);
            
            unsubscribeCatalog = onSnapshot(q, (snapshot) => {
                catalogData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (currentView === 'community' && communityTab === 'catalog') {
                    renderCatalog();
                }
            }, (error) => {
                console.error("Error al escuchar el catálogo:", error);
            });
        }

        // Limpiar y configurar el listener del chat
        function setupChatListener() {
            if (unsubscribeChat) unsubscribeChat(); // Limpiar listener anterior
            if (!userId) return;

            const chatContainer = document.getElementById('chatMessages');
            if (!chatContainer) return;

            // Ordenar por timestamp descendente para obtener los más nuevos
            const q = query(collection(db, CHAT_COLLECTION_PATH), orderBy('timestamp', 'desc'));
            
            unsubscribeChat = onSnapshot(q, (snapshot) => {
                const messages = snapshot.docs.map(doc => doc.data()).reverse(); // Revertir para mostrar los nuevos abajo
                renderChatMessages(messages);
            }, (error) => {
                console.error("Error al escuchar el chat:", error);
                if(document.getElementById('chatMessages')) {
                    document.getElementById('chatMessages').innerHTML = `<p class="text-red-400 p-4">${T('error_auth')}: No se pudo cargar el chat.</p>`;
                }
            });
        }

        window.handleSendMessage = async () => {
            const chatInput = document.getElementById('chatInput');
            const messageText = chatInput.value.trim();

            if (!messageText || !userId) return;

            try {
                await addDoc(collection(db, CHAT_COLLECTION_PATH), {
                    text: messageText,
                    timestamp: serverTimestamp(),
                    userId: userId,
                    userName: userName || T('user_anon')
                });
                chatInput.value = '';
            } catch (e) {
                console.error("Error al enviar mensaje:", e);
                displayStatus("Error al enviar el mensaje.", 'text-red-400');
            }
        };
        
        // ===============================================
        // 6. LÓGICA DE ANÁLISIS IA (Vision API)
        // ===============================================
        
        window.previewImage = function(event) {
            const file = event.target.files[0];
            const inputImage = document.getElementById('inputImage');
            const analyzeButton = document.getElementById('analyzeButton');

            if (!file) return;

            if (!file.type.startsWith('image/')) {
                displayStatus(T('error_upload'), 'text-red-400');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                inputImage.src = e.target.result;
                inputImage.classList.remove('hidden');
                analyzeButton.disabled = false;
                base64Image = e.target.result.split(',')[1];
                displayStatus(T('status_loaded'), 'text-gray-400');
                document.getElementById('resultsSection')?.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        window.analyzeWatch = async function() {
            if (!base64Image) { displayStatus(T('error_upload'), 'text-red-400'); return; }

            const analyzeButton = document.getElementById('analyzeButton');
            const spinner = document.getElementById('spinner');
            const buttonText = document.getElementById('buttonText');
            
            analyzeButton.disabled = true;
            buttonText.textContent = T('status_analyzing');
            spinner.classList.remove('hidden');
            document.getElementById('resultsSection')?.classList.add('hidden');
            displayStatus("", 'text-gray-400'); 

            const payload = {
                requests: [{ image: { content: base64Image }, features: [{ type: "LABEL_DETECTION", maxResults: 5 }, { type: "WEB_DETECTION", maxResults: 10 }] }]
            };

            try {
                const response = await fetch(VISION_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.status === 403) {
                    displayStatus(T('error_403'), 'text-red-500 font-bold');
                    throw new Error(`Error HTTP 403`);
                }
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const data = await response.json();
                processResults(data);

            } catch (error) {
                console.error("Error en la llamada a la API:", error);
                displayStatus("Error de conexión o API. Revise la Consola (F12).", 'text-red-400');
                updateUIForError();
            }
        }

        function processResults(data) {
            let watchData = null;

            try {
                // Lógica de identificación mejorada para buscar en nuestro catálogo de Firestore
                const webEntities = data.responses[0].webDetection?.webEntities || [];
                
                if (webEntities.length > 0) {
                    // Buscar coincidencia en el catálogo con los nombres de las entidades web
                    for (const entity of webEntities) {
                        const description = entity.description ? entity.description.toLowerCase() : '';
                        watchData = catalogData.find(watch => description.includes(watch.id.toLowerCase()));
                        if (watchData) break;
                    }
                }
                
                // Fallback si no se encuentra en el catálogo
                if (!watchData) {
                    watchData = {
                        id: "no_identificado", 
                        name: "Modelo no identificado", 
                        caliber: "Desconocido", 
                        price: "Consultar mercado", 
                        history: "La IA no pudo vincular la imagen a un modelo específico en nuestro catálogo. Intente con una foto más clara del cuadrante.",
                        imageUrl: "https://placehold.co/150x150/161b22/8b949e?text=?"
                    };
                }

                // Actualizar la interfaz de usuario con los resultados
                document.getElementById('watchName').textContent = watchData.id.toUpperCase();
                document.getElementById('modelName').textContent = watchData.name;
                document.getElementById('caliber').textContent = watchData.caliber;
                document.getElementById('priceRange').textContent = watchData.price;
                document.getElementById('historySummary').textContent = watchData.history;

                document.getElementById('resultsSection')?.classList.remove('hidden');
                displayStatus(T('status_complete'), 'text-green-400');

            } catch (e) {
                console.error("Error al procesar la estructura de datos:", e);
                displayStatus("Error al procesar los resultados de la IA.", 'text-red-400');
            } finally {
                updateUIForSuccess();
            }
        }
        
        // ===============================================
        // 7. RENDERING Y CONTROL DE VISTAS (UI)
        // ===============================================
        
        window.setView = (view) => {
            if ((view === 'analyze' || view === 'community') && !userId) view = 'auth'; // Forzar Auth
            currentView = view;
            updateUI();
        };

        window.setCommunityTab = (tab) => {
            communityTab = tab;
            updateUI();
        }

        function displayStatus(message, colorClass) {
            const statusMessage = document.getElementById('statusMessage');
            if(statusMessage) {
                statusMessage.textContent = message;
                statusMessage.className = `mt-4 text-center text-sm ${colorClass}`;
                statusMessage.classList.remove('hidden');
            }
        }

        function updateUIForError() {
            const analyzeButton = document.getElementById('analyzeButton');
            const buttonText = document.getElementById('buttonText');
            const spinner = document.getElementById('spinner');

            if (analyzeButton) analyzeButton.disabled = false;
            if (buttonText) buttonText.textContent = T('analyze_button');
            if (spinner) spinner.classList.add('hidden');
        }

        function updateUIForSuccess() {
            updateUIForError(); // Restablece el botón de análisis
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

        function updateUI() {
            const appContainer = document.getElementById('appContainer');
            const mainNav = document.getElementById('mainNav');
            const currentUserDisplay = document.getElementById('currentUserDisplay');

            // 1. No hacer nada si todavía estamos cargando el estado de autenticación
            if (!isAuthReady) {
                appContainer.innerHTML = `<div class="text-center py-10 text-gray-500" data-key="loading_app">${T('loading_app')}</div>`;
                return;
            }

            // 2. Mostrar/Ocultar y actualizar la navegación principal
            if (userId) {
                mainNav.classList.remove('hidden');
                currentUserDisplay.textContent = `${T('current_user')} ${userName.length > 20 ? userName.substring(0, 17) + '...' : userName}`;
                
                // Actualizar el estado activo de la navegación
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('tab-active');
                });
                document.getElementById(`nav${currentView.charAt(0).toUpperCase() + currentView.slice(1)}`)?.classList.add('tab-active');

            } else {
                mainNav.classList.add('hidden');
                currentView = 'auth';
            }
            
            // 3. Renderizar la vista actual
            appContainer.innerHTML = '';
            
            if (currentView === 'auth') {
                appContainer.innerHTML = renderAuthView();
            } else if (currentView === 'analyze') {
                appContainer.innerHTML = renderAnalyzeView();
            } else if (currentView === 'community') {
                appContainer.innerHTML = renderCommunityView();
            }

            // 4. Aplicar traducciones a la vista recién cargada
            applyTranslations();
            
            // 5. Inicializar listeners específicos de la vista
            // Se limpian y reconfiguran los listeners de Firestore cada vez que se actualiza la UI para asegurar la reactividad
            if (currentView === 'community') {
                setupCatalogListener();
                if (communityTab === 'chat') {
                    setupChatListener();
                } else if (communityTab === 'catalog') {
                    renderCatalog();
                }
            } else {
                // Limpiar listeners si salimos de la vista de comunidad
                if (unsubscribeCatalog) { unsubscribeCatalog(); unsubscribeCatalog = null; }
                if (unsubscribeChat) { unsubscribeChat(); unsubscribeChat = null; }
            }
            
            // 6. Actualizar el marcador de idioma
            document.querySelectorAll('[data-lang-btn]').forEach(btn => {
                btn.dataset.active = (btn.getAttribute('data-lang-btn') === currentLang);
            });
        }
        
        // ===============================================
        // 8. TEMPLATES (HTML strings)
        // ===============================================

        function renderAuthView() {
            return `
                <div class="card p-8 rounded-xl max-w-sm mx-auto">
                    <h2 class="text-xl font-bold text-center mb-6" data-key="login_title">Ingresar a WatchNow</h2>
                    <form id="authForm" onsubmit="return false">
                        <div class="mb-4">
                            <label for="email" class="block text-gray-400 text-sm font-medium mb-1" data-key="login_email">Correo Electrónico</label>
                            <input type="email" id="email" required class="w-full px-3 py-2 bg-[#2d333b] border border-gray-600 rounded-lg text-white focus:ring-green-500 focus:border-green-500">
                        </div>
                        <div class="mb-6">
                            <label for="password" class="block text-gray-400 text-sm font-medium mb-1" data-key="login_password">Contraseña</label>
                            <input type="password" id="password" required class="w-full px-3 py-2 bg-[#2d333b] border border-gray-600 rounded-lg text-white focus:ring-green-500 focus:border-green-500">
                        </div>
                        <p id="authError" class="text-red-400 text-sm text-center mb-4"></p>
                        
                        <div class="space-y-3">
                            <button type="button" onclick="handleSignIn(document.getElementById('email').value, document.getElementById('password').value)" class="w-full btn-primary text-white font-semibold py-2 rounded-lg" data-key="login_button">Iniciar Sesión</button>
                            <button type="button" onclick="handleSignUp(document.getElementById('email').value, document.getElementById('password').value)" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 rounded-lg transition duration-150" data-key="signup_button">Crear Cuenta</button>
                            <button type="button" onclick="handleAnonSignIn()" class="w-full text-gray-400 hover:text-white text-sm py-2" data-key="login_anon_button">Continuar como Anónimo</button>
                        </div>
                    </form>
                </div>
            `;
        }

        function renderAnalyzeView() {
            return `
                <!-- Contenedor de Análisis IA -->
                <div class="card p-6 rounded-xl">
                    <!-- 1. Carga de Imagen -->
                    <section id="upload-section" class="mb-6">
                        <label for="fileInput" class="block text-center cursor-pointer p-4 border-2 border-dashed border-gray-600 rounded-lg hover:border-gray-500 transition duration-150">
                            <svg class="mx-auto h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 18m-4-12v6m0 0l-3-3m3 3l3-3"/>
                            </svg>
                            <p class="mt-2 text-sm text-gray-300" data-key="select_image_prompt">Toca para seleccionar una imagen clara del reloj</p>
                        </label>
                        <input type="file" id="fileInput" accept="image/*" onchange="previewImage(event)">
                        <img id="inputImage" class="hidden mx-auto" alt="Imagen de Reloj a analizar" onerror="this.src='https://placehold.co/150x150/161b22/8b949e?text=WATCH'">
                    </section>

                    <!-- 2. Botón de Acción -->
                    <button id="analyzeButton" onclick="analyzeWatch()" class="w-full btn-primary text-white font-semibold py-3 rounded-lg flex items-center justify-center transition duration-150" disabled>
                        <span id="buttonText" data-key="analyze_button">Analizar Reloj y Buscar</span>
                        <div id="spinner" class="spinner w-5 h-5 border-2 border-t-white rounded-full ml-3 hidden"></div>
                    </button>

                    <!-- 3. Mensaje de Estado / Error -->
                    <p id="statusMessage" class="mt-4 text-center text-sm text-gray-400 hidden"></p>
                </div>

                <!-- 4. Sección de Resultados -->
                <section id="resultsSection" class="mt-8 card p-6 rounded-xl hidden">
                    <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2" data-key="results_title">Resultados del Análisis</h2>
                    
                    <div class="space-y-4">
                        <div class="result-item">
                            <p class="text-gray-400 text-sm" data-key="ident_ia">Identificación IA:</p>
                            <p id="watchName" class="text-lg font-semibold text-green-400">...</p>
                        </div>
                        <div class="result-item border-t border-gray-800 pt-4">
                            <p class="text-gray-400 text-sm" data-key="model_estimated">Modelo Estimado (Catálogo):</p>
                            <p id="modelName" class="text-base font-medium">--</p>
                        </div>
                        <div class="result-item">
                            <p class="text-gray-400 text-sm" data-key="caliber">Calibre / Movimiento:</p>
                            <p id="caliber" class="text-base font-medium">--</p>
                        </div>
                        <div class="result-item">
                            <p class="text-gray-400 text-sm" data-key="price_range">Precio Estimado (Rango USD):</p>
                            <p id="priceRange" class="text-base font-medium text-yellow-400">--</p>
                        </div>
                    </div>

                    <div class="result-item border-t border-gray-800 pt-4 mt-4">
                        <p class="text-gray-400 text-sm" data-key="history_summary">Resumen Histórico:</p>
                        <p id="historySummary" class="text-sm leading-relaxed text-gray-300">--</p>
                    </div>
                </section>
            `;
        }

        function renderCommunityView() {
            const isCatalogActive = communityTab === 'catalog';
            const isChatActive = communityTab === 'chat';

            return `
                <div class="card p-6 rounded-xl">
                    <!-- Tabs de Comunidad -->
                    <div class="flex border-b border-gray-700 mb-6">
                        <button onclick="setCommunityTab('catalog')" class="flex-1 text-center py-2 font-semibold ${isCatalogActive ? 'tab-active' : 'text-gray-400'}" data-key="tab_catalog">Catálogo</button>
                        <button onclick="setCommunityTab('chat')" class="flex-1 text-center py-2 font-semibold ${isChatActive ? 'tab-active' : 'text-gray-400'}" data-key="tab_chat">Chat Comunitario</button>
                    </div>

                    <!-- Contenido del Tab -->
                    ${isCatalogActive ? renderCatalogTemplate() : renderChatTemplate()}
                </div>
            `;
        }
        
        function renderCatalogTemplate() {
            return `
                <h2 class="text-xl font-bold mb-4" data-key="catalog_title">Catálogo de Relojes Comunitario</h2>
                <p class="text-gray-400 text-sm mb-4" data-key="catalog_prompt">Explora la colección o usa el Análisis IA para identificar un reloj.</p>
                <div id="catalogList" class="space-y-4">
                    <!-- Los relojes del Catálogo se renderizarán aquí -->
                    <p class="text-gray-500 text-center">Cargando catálogo...</p>
                </div>
            `;
        }
        
        function renderChatTemplate() {
            return `
                <h2 class="text-xl font-bold mb-4" data-key="chat_title">Chat de Coleccionistas</h2>
                
                <!-- Contenedor de Mensajes -->
                <div id="chatMessages" class="h-80 overflow-y-auto p-3 mb-4 card border-none bg-[#0d1117]/50 flex flex-col space-y-3">
                    <p class="text-gray-500 text-center">Cargando mensajes...</p>
                </div>
                
                <!-- Formulario de Chat -->
                <div class="flex space-x-2">
                    <input type="text" id="chatInput" placeholder="${T('chat_placeholder')}" onkeydown="if(event.key === 'Enter') handleSendMessage()" 
                           class="flex-grow px-4 py-2 bg-[#2d333b] border border-gray-600 rounded-full text-white focus:ring-green-500 focus:border-green-500">
                    <button onclick="handleSendMessage()" class="btn-primary text-white font-semibold px-4 py-2 rounded-full flex-shrink-0" data-key="send_button">Enviar</button>
                </div>
            `;
        }

        function renderCatalog() {
            const catalogList = document.getElementById('catalogList');
            if (!catalogList) return;

            if (catalogData.length === 0) {
                 catalogList.innerHTML = `<p class="text-gray-500 text-center">${T('catalog_prompt')}</p>`;
                 return;
            }
            
            catalogList.innerHTML = catalogData.map(watch => `
                <div class="flex items-start space-x-4 p-3 border border-gray-700 rounded-lg hover:bg-[#1f242c] transition duration-150">
                    <img src="${watch.imageUrl || 'https://placehold.co/80x80/161b22/8b949e?text=WATCH'}" class="w-16 h-16 rounded-lg object-cover" alt="Reloj ${watch.name}">
                    <div class="flex-grow">
                        <h3 class="text-lg font-semibold text-green-400">${watch.name} (${watch.id.toUpperCase()})</h3>
                        <p class="text-sm text-gray-300">Calibre: ${watch.caliber}</p>
                        <p class="text-sm text-yellow-400 font-medium">Precio Est.: ${watch.price}</p>
                        <p class="text-xs text-gray-500 mt-1">${watch.history.substring(0, 70)}...</p>
                    </div>
                </div>
            `).join('');
        }
        
        function renderChatMessages(messages) {
            const chatContainer = document.getElementById('chatMessages');
            if (!chatContainer) return;

            // Guardar si el scroll está cerca del fondo antes de renderizar
            const shouldScroll = chatContainer.scrollTop + chatContainer.clientHeight >= chatContainer.scrollHeight - 50; 

            chatContainer.innerHTML = messages.map(msg => {
                const isUser = msg.userId === userId;
                // Formatear el timestamp (si existe)
                const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString(currentLang) : '...';
                
                return `
                    <div class="flex ${isUser ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-xs md:max-w-md p-3 rounded-xl shadow-md message-bubble-${isUser ? 'user' : 'other'}">
                            <div class="text-xs font-bold ${isUser ? 'text-gray-900' : 'text-green-400'} mb-1">${msg.userName}</div>
                            <p class="text-sm ${isUser ? 'text-white' : 'text-gray-200'}">${msg.text}</p>
                            <div class="text-right text-xs mt-1 ${isUser ? 'text-gray-300' : 'text-gray-400'}">${time}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Solo desplazarse al último mensaje si el usuario ya estaba abajo
            if (shouldScroll) {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }


        // ===============================================
        // 9. SETUP INICIAL DE LA APP Y DATA MOCK
        // ===============================================

        // Función para cargar los datos iniciales del catálogo a Firestore (solo si está vacío)
        async function initializeCatalogData() {
             const MOCK_CATALOG = [
                { id: "rolex submariner", name: "Rolex Submariner Date", caliber: "Calibre 3235", price: "USD 12,000 - 18,000", history: "Lanzado en 1953, fue el primer reloj de buceo resistente al agua hasta 100 metros. Es un ícono de durabilidad y diseño, popularizado por exploradores y James Bond.", imageUrl: "https://placehold.co/80x80/0d1117/30363d?text=SUB" },
                { id: "omega speedmaster", name: "Omega Speedmaster Professional", caliber: "Calibre 1861/3861 (Manual)", price: "USD 5,500 - 8,000", history: "Conocido como el 'Moonwatch' por ser el reloj oficial usado por los astronautas de la NASA en la Luna. Es uno de los cronógrafos más probados y fiables de la historia.", imageUrl: "https://placehold.co/80x80/0d1117/30363d?text=OMGA" },
                { id: "patek philippe nautilus", name: "Patek Philippe Nautilus 5711", caliber: "Calibre 26-330 S C", price: "USD 70,000 - 150,000+", history: "Diseñado por Gerald Genta en 1976. Su diseño icónico de 'ojo de buey' y su estatus de lujo lo han convertido en uno de los relojes más deseados y difíciles de obtener en el mundo.", imageUrl: "https://placehold.co/80x80/0d1117/30363d?text=PATEK" },
                { id: "garmin fenix", name: "Garmin Fēnix Series (Reloj Deportivo)", caliber: "Digital / GPS", price: "USD 400 - 1,200", history: "Un reloj multideporte de alta gama, conocido por sus avanzadas funciones de GPS, seguimiento de actividad, mapas topográficos y larga duración de batería. Popular entre corredores y excursionistas.", imageUrl: "https://placehold.co/80x80/0d1117/30363d?text=GRMN" }
            ];

            const catalogRef = collection(db, CATALOG_COLLECTION_PATH);
            try {
                // Intentar obtener un documento para ver si la colección ya tiene datos
                const snapshot = await getDocs(query(catalogRef));
                
                if (snapshot.empty) {
                    console.log("Inicializando catálogo con datos de ejemplo...");
                    for (const watch of MOCK_CATALOG) {
                        // Usamos el ID como nombre de documento para facilitar la búsqueda
                        await setDoc(doc(catalogRef, watch.id), watch);
                    }
                }
            } catch (e) {
                console.error("No se pudo inicializar o acceder al catálogo (Verifique Reglas de Seguridad):", e);
            }
        }
        
        // La inicialización de la lógica (initAuth y initializeCatalogData) ahora se llama 
        // desde document.addEventListener('DOMContentLoaded', ...) para asegurar que el DOM esté listo.
    </script>
</body>
</html>
