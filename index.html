<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Im√°genes Gemini</title>
    <!-- Carga de Tailwind CSS para un dise√±o moderno y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'gemini-blue': '#4285F4',
                        'gemini-dark': '#1A1A1A',
                        'gemini-light': '#F8F9FA',
                    },
                }
            }
        }
    </script>
    <style>
        /* Estilos personalizados para el spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #4285F4;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4 font-sans">

    <div id="app" class="bg-white p-6 md:p-10 rounded-xl shadow-2xl w-full max-w-2xl">
        <h1 class="text-3xl font-bold text-center text-gemini-dark mb-6">üñºÔ∏è Generador de Im√°genes con Gemini</h1>
        <p class="text-center text-gray-600 mb-8">Escribe una descripci√≥n de la imagen que quieres crear. Utiliza descripciones detalladas para obtener mejores resultados.</p>

        <!-- Formulario de Entrada -->
        <div class="space-y-4 mb-6">
            <textarea id="promptInput" rows="3" placeholder="Ej: Un perro samoyedo con gafas de sol, flotando en el espacio con estrellas brillantes, estilo arte digital 4K."
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gemini-blue focus:border-gemini-blue resize-none"></textarea>
            
            <button id="generateButton" onclick="generateImage()"
                    class="w-full bg-gemini-blue hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-300 ease-in-out shadow-lg flex items-center justify-center disabled:opacity-50">
                <span id="buttonText">Generar Imagen</span>
                <div id="loadingSpinner" class="spinner ml-3 hidden"></div>
            </button>
        </div>

        <!-- √Årea de Resultados y Mensajes -->
        <div id="resultArea" class="mt-8">
            <div id="messageBox" class="text-center p-3 rounded-lg hidden">
                <!-- Mensajes de estado, error o √©xito aqu√≠ -->
            </div>
            
            <!-- Contenedor de la Imagen Generada -->
            <div id="imageContainer" class="bg-gray-200 rounded-lg overflow-hidden flex items-center justify-center aspect-square shadow-inner transition duration-500 ease-in-out">
                <p id="initialMessage" class="text-gray-500 p-4">La imagen generada aparecer√° aqu√≠. Esto puede tardar unos segundos.</p>
                <img id="generatedImage" class="w-full h-full object-cover hidden" alt="Imagen Generada por IA">
            </div>
        </div>
    </div>

    <script type="module">
        // Variables globales predefinidas por el entorno Canvas
        const apiKey = typeof __api_key !== 'undefined' ? __api_key : '';

        const promptInput = document.getElementById('promptInput');
        const generateButton = document.getElementById('generateButton');
        const buttonText = document.getElementById('buttonText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const resultArea = document.getElementById('resultArea');
        const messageBox = document.getElementById('messageBox');
        const imageContainer = document.getElementById('imageContainer');
        const generatedImage = document.getElementById('generatedImage');
        const initialMessage = document.getElementById('initialMessage');

        // --- L√≥gica de Manejo de API con Reintentos (Exponential Backoff) ---

        /**
         * Realiza una solicitud fetch con reintentos y retroceso exponencial.
         * Esto es crucial para manejar fallos de red o l√≠mites de tasa temporales.
         */
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response; // √âxito
                    }
                    
                    // Si la respuesta no es OK pero no es un error de cliente (4xx), reintentar
                    if (response.status < 400 || response.status >= 500) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`Intento ${i + 1} fallido (Status: ${response.status}). Reintentando en ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    
                    // Para errores de cliente (4xx) o si se agotan los reintentos
                    const errorJson = await response.json();
                    throw new Error(`Error de la API (Status: ${response.status}): ${errorJson.error.message || JSON.stringify(errorJson)}`);

                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw new Error(`Fallo en la conexi√≥n despu√©s de ${maxRetries} intentos: ${error.message}`);
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`Error de red en intento ${i + 1}: ${error.message}. Reintentando en ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        /**
         * Funci√≥n principal para generar la imagen.
         */
        window.generateImage = async function() {
            const prompt = promptInput.value.trim();

            if (!prompt) {
                showMessage("Por favor, introduce una descripci√≥n para generar la imagen.", 'bg-yellow-100 text-yellow-800');
                return;
            }

            // 1. Mostrar estado de carga (para resolver el "no carga")
            setState('loading');
            
            // 2. Ocultar mensajes de error anteriores y la imagen
            hideImage();
            showMessage("", "", true); // Limpiar mensajeBox

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;

            // Configuraci√≥n del payload para el modelo Imagen
            const payload = {
                instances: [{ prompt: prompt }],
                parameters: { "sampleCount": 1 }
            };

            try {
                // 3. Realizar la llamada a la API con reintentos
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();

                // 4. Procesar la respuesta
                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const base64Data = result.predictions[0].bytesBase64Encoded;
                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    
                    // Mostrar la imagen
                    generatedImage.src = imageUrl;
                    showImage();
                    showMessage("¬°Imagen generada con √©xito! üéâ", 'bg-green-100 text-green-800');

                } else {
                    // Manejar una respuesta v√°lida pero sin imagen
                    throw new Error("La API no devolvi√≥ datos de imagen v√°lidos. Intenta con un prompt diferente.");
                }
            } catch (error) {
                // 5. Manejar cualquier error de la llamada (incluyendo los de fetchWithRetry)
                console.error("Error durante la generaci√≥n de la imagen:", error);
                showMessage(`Error: ${error.message}. Por favor, revisa la consola para m√°s detalles.`, 'bg-red-100 text-red-800');
            } finally {
                // 6. Restablecer el estado
                setState('idle');
            }
        }

        /**
         * Muestra/oculta mensajes de estado o error.
         */
        function showMessage(text, className, clear = false) {
            messageBox.textContent = text;
            messageBox.className = `text-center p-3 rounded-lg ${className}`;
            if (text && !clear) {
                messageBox.classList.remove('hidden');
            } else {
                messageBox.classList.add('hidden');
            }
        }

        /**
         * Muestra el contenedor de la imagen y oculta el mensaje inicial.
         */
        function showImage() {
            initialMessage.classList.add('hidden');
            generatedImage.classList.remove('hidden');
            imageContainer.classList.remove('bg-gray-200'); // Quitar fondo gris cuando la imagen est√° visible
        }

        /**
         * Oculta la imagen y muestra el mensaje inicial.
         */
        function hideImage() {
            generatedImage.classList.add('hidden');
            generatedImage.src = ''; // Limpiar la fuente
            initialMessage.classList.remove('hidden');
            imageContainer.classList.add('bg-gray-200');
        }

        /**
         * Controla el estado de la interfaz de usuario (idle/loading).
         */
        function setState(state) {
            if (state === 'loading') {
                generateButton.disabled = true;
                buttonText.textContent = 'Generando...';
                loadingSpinner.classList.remove('hidden');
                promptInput.disabled = true;
                showMessage("Generando la imagen, por favor espera...", 'bg-blue-100 text-blue-800');
            } else { // 'idle'
                generateButton.disabled = false;
                buttonText.textContent = 'Generar Imagen';
                loadingSpinner.classList.add('hidden');
                promptInput.disabled = false;
                // Si ya se mostr√≥ la imagen, no limpiar el mensaje, si no, limpiar
                if (!generatedImage.src) {
                     showMessage("", "", true); // Limpiar
                }
            }
        }

        // Inicializar la interfaz al cargar
        window.onload = function() {
            setState('idle');
            hideImage(); // Asegurar que solo se vea el mensaje inicial
        };

    </script>
</body>
</html>
