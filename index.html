<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WatchNow - Identificación de Relojes con IA</title>
    <!-- Carga de Tailwind CSS (para estilos modernos y responsivos) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente principal Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Fondo oscuro tipo GitHub */
        }
        .container-app {
            max-width: 500px;
            min-height: 100vh;
            padding: 1.5rem;
        }
        .card {
            background-color: #161b22; /* Color de fondo de las tarjetas */
            border: 1px solid #30363d;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #238636;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2ea043;
        }
        .spinner {
            border-top-color: #238636;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Estilos específicos para la imagen de entrada */
        #inputImage {
            max-height: 300px;
            object-fit: contain;
            width: 100%;
            border-radius: 0.5rem;
            margin-top: 1rem;
            border: 2px dashed #30363d;
            padding: 10px;
        }
        /* Ocultar el input de archivo */
        #fileInput {
            display: none;
        }
    </style>
</head>
<body class="flex justify-center items-start">

    <div class="container-app mx-auto text-white">
        
        <!-- Encabezado de la Aplicación -->
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-[#238636]">WatchNow</h1>
            <p class="text-gray-400">Identificación y Valoración de Relojes con IA</p>
        </header>

        <!-- Contenedor Principal (Card) -->
        <div class="card p-6 rounded-xl">

            <!-- 1. Carga de Imagen -->
            <section id="upload-section" class="mb-6">
                <label for="fileInput" class="block text-center cursor-pointer p-4 border-2 border-dashed border-gray-600 rounded-lg hover:border-gray-500 transition duration-150">
                    <svg class="mx-auto h-8 w-8 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 18m-4-12v6m0 0l-3-3m3 3l3-3"/>
                    </svg>
                    <p class="mt-2 text-sm text-gray-300">Toca para seleccionar una imagen clara del reloj</p>
                </label>
                <input type="file" id="fileInput" accept="image/*" onchange="previewImage(event)">
                <img id="inputImage" class="hidden mx-auto" alt="Imagen de Reloj a analizar">
            </section>

            <!-- 2. Botón de Acción -->
            <button id="analyzeButton" onclick="analyzeWatch()" class="w-full btn-primary text-white font-semibold py-3 rounded-lg flex items-center justify-center transition duration-150" disabled>
                <span id="buttonText">Analizar y Buscar Historia</span>
                <div id="spinner" class="spinner w-5 h-5 border-2 border-t-white rounded-full ml-3 hidden"></div>
            </button>

            <!-- 3. Mensaje de Estado / Error -->
            <p id="statusMessage" class="mt-4 text-center text-sm text-gray-400 hidden"></p>
        </div>

        <!-- 4. Sección de Resultados -->
        <section id="resultsSection" class="mt-8 card p-6 rounded-xl hidden">
            <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">Resultados del Análisis</h2>
            
            <div class="space-y-4">
                <!-- Resultado de la IA (Identificación) -->
                <div class="result-item">
                    <p class="text-gray-400 text-sm">Identificación IA:</p>
                    <p id="watchName" class="text-lg font-semibold text-green-400">Cargando...</p>
                </div>

                <!-- Detalles de la Base de Datos (Historia/Calibre) -->
                <div class="result-item border-t border-gray-800 pt-4">
                    <p class="text-gray-400 text-sm">Modelo Estimado (Base de Datos):</p>
                    <p id="modelName" class="text-base font-medium">--</p>
                </div>
                <div class="result-item">
                    <p class="text-gray-400 text-sm">Calibre / Movimiento:</p>
                    <p id="caliber" class="text-base font-medium">--</p>
                </div>
                <div class="result-item">
                    <p class="text-gray-400 text-sm">Precio Estimado (Rango USD):</p>
                    <p id="priceRange" class="text-base font-medium text-yellow-400">--</p>
                </div>
            </div>

            <div class="result-item border-t border-gray-800 pt-4 mt-4">
                <p class="text-gray-400 text-sm">Resumen Histórico:</p>
                <p id="historySummary" class="text-sm leading-relaxed text-gray-300">--</p>
            </div>
        </section>

    </div>

    <!-- Script de Firebase (para futura base de datos) y Lógica de IA -->
    <script>
        // ⚠️ CLAVE DE API ACTUALIZADA POR SOLICITUD DEL USUARIO.
        const API_KEY = "AIzaSyAf0on8I9CRYx5uOsGmnWDr81EfHQDRcpw"; 
        const VISION_API_URL = `https://vision.googleapis.com/v1/images:annotate?key=${API_KEY}`;

        const fileInput = document.getElementById('fileInput');
        const inputImage = document.getElementById('inputImage');
        const analyzeButton = document.getElementById('analyzeButton');
        const spinner = document.getElementById('spinner');
        const buttonText = document.getElementById('buttonText');
        const statusMessage = document.getElementById('statusMessage');
        const resultsSection = document.getElementById('resultsSection');
        
        let base64Image = null;

        // Base de datos de ejemplo (simulando datos de modelos populares)
        const WATCH_DATABASE = [
            { id: "rolex submariner", name: "Rolex Submariner Date", caliber: "Calibre 3235", price: "USD 12,000 - 18,000", history: "Lanzado en 1953, fue el primer reloj de buceo resistente al agua hasta 100 metros. Es un ícono de durabilidad y diseño, popularizado por exploradores y James Bond." },
            { id: "rolex daytona", name: "Rolex Cosmograph Daytona", caliber: "Calibre 4130", price: "USD 25,000 - 45,000", history: "Diseñado en 1963 para pilotos de carreras de resistencia. Es famoso por su escala taquimétrica y por ser el reloj de Paul Newman. Su disponibilidad limitada lo hace extremadamente valioso." },
            { id: "omega speedmaster", name: "Omega Speedmaster Professional", caliber: "Calibre 1861/3861 (Manual)", price: "USD 5,500 - 8,000", history: "Conocido como el 'Moonwatch' por ser el reloj oficial usado por los astronautas de la NASA en la Luna. Es uno de los cronógrafos más probados y fiables de la historia." },
            { id: "patek philippe nautilus", name: "Patek Philippe Nautilus 5711", caliber: "Calibre 26-330 S C", price: "USD 70,000 - 150,000+", history: "Diseñado por Gerald Genta en 1976. Su diseño icónico de 'ojo de buey' y su estatus de lujo lo han convertido en uno de los relojes más deseados y difíciles de obtener en el mundo." },
            { id: "tag heuer carrera", name: "TAG Heuer Carrera Chronograph", caliber: "Calibre 16/Heuer 02", price: "USD 3,000 - 6,500", history: "Creado por Jack Heuer en 1963, en honor a la peligrosa carrera automovilística 'Carrera Panamericana'. Es sinónimo de deporte motor y legibilidad." },
            { id: "reloj", name: "Reloj Genérico", caliber: "Movimiento Desconocido", price: "USD 50 - 500", history: "La IA identificó solo un 'reloj'. No hay suficiente detalle para identificar la marca. Intente subir una imagen más clara y de primer plano del cuadrante." },
            { id: "brazalete", name: "Pulsera/Brazalete", caliber: "N/A", price: "N/A", history: "La IA identificó una pulsera o brazalete en lugar de un reloj completo. Asegúrese de que el reloj esté centrado en la toma." },
        ];


        // 1. Previsualiza la imagen y convierte a Base64
        function previewImage(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validación básica de imagen
            if (!file.type.startsWith('image/')) {
                displayStatus("Error: Por favor, seleccione un archivo de imagen válido.", 'text-red-400');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                inputImage.src = e.target.result;
                inputImage.classList.remove('hidden');
                analyzeButton.disabled = false;
                base64Image = e.target.result.split(',')[1]; // Elimina el prefijo data:image/...
                displayStatus("Imagen cargada. Lista para analizar.", 'text-gray-400');
                resultsSection.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        }

        // 2. Llama a la API de Google Cloud Vision
        async function analyzeWatch() {
            if (!base64Image) {
                displayStatus("Error: Por favor, suba una imagen primero.", 'text-red-400');
                return;
            }

            // Muestra indicador de carga
            analyzeButton.disabled = true;
            buttonText.textContent = "Analizando...";
            spinner.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            displayStatus("", 'text-gray-400'); // Limpia el estado

            const payload = {
                requests: [
                    {
                        image: { content: base64Image },
                        features: [
                            { type: "LABEL_DETECTION", maxResults: 5 }, // Para etiquetas generales (reloj, pulsera)
                            { type: "WEB_DETECTION", maxResults: 5 }  // Para identificar marcas y modelos web
                        ]
                    }
                ]
            };

            try {
                const response = await fetch(VISION_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.status === 400) {
                    // Posiblemente error de clave de API o formato JSON.
                    const errorData = await response.json();
                    const errorMessage = errorData.error?.message || "Error desconocido de la API.";
                    
                    if (errorMessage.includes("API key not valid")) {
                        displayStatus("Error Crítico: Clave de API Inválida. Verifique que la clave es correcta y que la Vision API está habilitada.", 'text-red-500 font-bold');
                    } else if (errorMessage.includes("API has not been used in project")) {
                        displayStatus("Error Crítico: Vision API No Activada. Active el servicio en Google Cloud.", 'text-red-500 font-bold');
                    } else {
                        displayStatus(`Error HTTP 400. Consulte la Consola (F12) para más detalles. Mensaje: ${errorMessage}`, 'text-red-400');
                    }
                    throw new Error(`Error HTTP 400: ${errorMessage}`);
                }
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const data = await response.json();
                
                // 3. Procesa los resultados y busca en la base de datos
                processResults(data);

            } catch (error) {
                console.error("Error en la llamada a la API:", error);
                // Si ya se manejó el 400, solo actualiza la UI.
                if (!error.message.includes("Error HTTP 400")) {
                    displayStatus(`Error en la conexión o análisis de IA. Verifique la red y la Consola. (${error.message})`, 'text-red-400');
                }
                updateUIForError();
            }
        }

        // 4. Procesa y muestra los resultados de la IA y la Base de Datos
        function processResults(data) {
            let topLabel = "reloj"; // Etiqueta por defecto si no se encuentra nada específico

            try {
                const webEntities = data.responses[0].webDetection?.webEntities || [];
                
                // Intentar encontrar una marca o modelo específico en las detecciones web
                if (webEntities.length > 0) {
                    for (const entity of webEntities) {
                        const description = entity.description ? entity.description.toLowerCase() : '';
                        if (description.includes("rolex submariner") || description.includes("submariner")) {
                            topLabel = "rolex submariner";
                            break;
                        } else if (description.includes("rolex daytona") || description.includes("daytona")) {
                            topLabel = "rolex daytona";
                            break;
                        } else if (description.includes("omega speedmaster") || description.includes("speedmaster")) {
                            topLabel = "omega speedmaster";
                            break;
                        } else if (description.includes("patek philippe nautilus") || description.includes("nautilus")) {
                            topLabel = "patek philippe nautilus";
                            break;
                        } else if (description.includes("tag heuer carrera") || description.includes("carrera")) {
                            topLabel = "tag heuer carrera";
                            break;
                        } else if (description.includes("watch") || description.includes("reloj")) {
                            // Continuar buscando un modelo más específico
                        }
                    }
                }

                // Si no se encontró nada específico de la web, usamos la detección de etiquetas (label detection)
                if (topLabel === "reloj") {
                    const labelAnnotations = data.responses[0].labelAnnotations || [];
                    if (labelAnnotations.length > 0) {
                        const labels = labelAnnotations.map(a => a.description.toLowerCase());
                        if (labels.some(l => l.includes("watch strap") || l.includes("bracelet"))) {
                            topLabel = "brazalete";
                        }
                    }
                }

                // Buscar datos en nuestra base de datos local
                const dbEntry = WATCH_DATABASE.find(item => item.id === topLabel) || WATCH_DATABASE.find(item => item.id === "reloj");

                // Actualizar la interfaz de usuario con los resultados
                document.getElementById('watchName').textContent = dbEntry.id.toUpperCase().replace('RELOJ', 'Reloj Básico');
                document.getElementById('modelName').textContent = dbEntry.name;
                document.getElementById('caliber').textContent = dbEntry.caliber;
                document.getElementById('priceRange').textContent = dbEntry.price;
                document.getElementById('historySummary').textContent = dbEntry.history;

                resultsSection.classList.remove('hidden');
                displayStatus("Análisis completado. Resultados encontrados.", 'text-green-400');

            } catch (e) {
                console.error("Error al procesar la estructura de datos:", e);
                displayStatus("Análisis de IA fallido. Intente con una imagen diferente o revise la consola.", 'text-red-400');
                updateUIForError();
            } finally {
                // Oculta indicador de carga
                updateUIForSuccess();
            }
        }
        
        // Funciones de utilidad para la UI
        function displayStatus(message, colorClass) {
            statusMessage.textContent = message;
            statusMessage.className = `mt-4 text-center text-sm ${colorClass}`;
            statusMessage.classList.remove('hidden');
        }

        function updateUIForError() {
            analyzeButton.disabled = false;
            buttonText.textContent = "Analizar y Buscar Historia";
            spinner.classList.add('hidden');
            // No ocultar resultsSection si el error es solo por la clave API (para dejar visible el mensaje de error crítico)
        }

        function updateUIForSuccess() {
            analyzeButton.disabled = false;
            buttonText.textContent = "Analizar de Nuevo";
            spinner.classList.add('hidden');
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        }

    </script>
</body>
</html>
