<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WatchNow: Trazador de Películas y Series</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1a1a2e; color: #ffffff; }
        .card { background-color: #2c2c54; border: 1px solid #4a4a70; border-radius: 12px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); }
        .btn-primary { background-color: #ff6b6b; color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #e65252; }
        .btn-secondary { background-color: #4a4a70; color: white; }
        .btn-secondary:hover { background-color: #5d5d88; }
        .input-field { background-color: #1a1a2e; border: 1px solid #4a4a70; color: white; }
        .tab-active { border-bottom: 3px solid #ff6b6b; font-weight: 700; color: #ff6b6b; }
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            background-color: #1a1a2e; z-index: 1000;
        }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #ff6b6b; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <!-- Pantalla de Carga (Inicialmente visible) -->
    <div id="loading-screen" class="flex flex-col items-center justify-center">
        <div class="spinner mb-4"></div>
        <p id="loading-text" class="text-xl font-semibold text-gray-300">Iniciando sistema...</p>
    </div>

    <!-- Contenedor Principal de la Aplicación (Inicialmente oculto) -->
    <div id="app-container" class="hidden max-w-5xl mx-auto">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-center text-ff6b6b">WatchNow</h1>
            <p class="text-center text-gray-400 mt-2" id="user-id-display">ID de Usuario: ...</p>
        </header>

        <!-- Pestañas de Navegación -->
        <div class="flex border-b border-gray-700 mb-8">
            <button id="tab-my-list" class="flex-1 py-3 px-4 text-lg tab-active" onclick="switchTab('my-list')">Mi Lista</button>
            <button id="tab-community" class="flex-1 py-3 px-4 text-lg" onclick="switchTab('community')">Comunidad</button>
        </div>

        <!-- Contenido de Mi Lista (Por defecto visible) -->
        <div id="my-list-content">
            <div class="card p-6 mb-8 shadow-lg">
                <h2 class="text-2xl font-semibold mb-4">Añadir Nuevo Título</h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="title-input" placeholder="Título de la película o serie" class="input-field p-3 flex-grow rounded-lg">
                    <select id="type-select" class="input-field p-3 rounded-lg">
                        <option value="movie">Película</option>
                        <option value="series">Serie</option>
                    </select>
                    <button onclick="addWatchItem()" class="btn-primary p-3 rounded-lg font-semibold whitespace-nowrap">Añadir a la Lista</button>
                </div>
            </div>

            <div id="my-watches-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Los elementos de la lista del usuario se insertarán aquí -->
            </div>
        </div>

        <!-- Contenido de Comunidad (Inicialmente oculto) -->
        <div id="community-content" class="hidden">
            <h2 class="text-3xl font-bold mb-6 text-center">Títulos Compartidos por la Comunidad</h2>
            <p class="text-gray-400 text-center mb-6">Explora lo que otros usuarios están viendo. Solo puedes ver y comentar, no eliminar.</p>
            <div id="community-watches-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Los elementos de la lista de la comunidad se insertarán aquí -->
            </div>
        </div>
    </div>
    
    <!-- Modal para Alertas y Confirmaciones (showModal) -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-gray-900">Alerta</h3>
            <p id="modal-msg" class="text-gray-700 mb-6"></p>
            <div id="modal-actions" class="flex justify-end gap-3">
                <button id="modal-close-btn" class="btn-secondary px-4 py-2 rounded-lg text-sm" onclick="document.getElementById('modal').classList.add('hidden')">Cerrar</button>
                <!-- Botón de Confirmación se inserta aquí dinámicamente -->
            </div>
        </div>
    </div>


    <!-- SCRIPTS DE FIREBASE Y LÓGICA -->
    <script type="module">

        // =================================================================
        // === ZONA CRÍTICA: CONFIGURACIÓN DE CLAVES (TUS VALORES REALES) ===
        // =================================================================
        // 1. App ID: Copia el 'appId' que obtuviste de Firebase.
        const __app_id = '1:12164521308:web:b12ef458fab9d1a7c6b599'; 

        // 2. CONFIGURACIÓN DE FIREBASE: Pega tu objeto firebaseConfig real aquí.
        const __firebase_config = JSON.stringify({
            "apiKey": "AIzaSyDfawZ2pQ0x9pCOVTYV35rpKI_0VeTDWMK", 
            "authDomain": "watch-now-54d2e.firebaseapp.com", 
            "projectId": "watch-now-54d2e", 
            "storageBucket": "watch-now-54d2e.firebasestorage.app", 
            "messagingSenderId": "T12164521308", 
            "appId": "1:12164521308:web:b12ef458fab9d1a7c6b599" 
        });

        const __initial_auth_token = ""; 

        // 3. LLAVE DE GEMINI: Pega aquí tu LLAVE de Google AI Studio. 
        const GEMINI_KEY = "AIzaSyAf0on8I9CRYx5uOsGmnwDr81EHQDRcpw"; 
        // =================================================================


        // =================================================================
        // === IMPORTS Y DECLARACIONES GLOBALES (¡NO DEBE HABER OTROS IMPORTS!) ===
        // =================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, setLogLevel, collection, query, where, doc, getDoc, 
            addDoc, updateDoc, deleteDoc, onSnapshot
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let app, db, auth;
        let currentUser = null;
        let currentWatchData = null;

        // Convertir la configuración de string JSON a objeto JavaScript
        const firebaseConfig = JSON.parse(__firebase_config);

        // =================================================================
        // === FUNCIÓN CRÍTICA DE INICIALIZACIÓN Y AUTENTICACIÓN ===
        // =================================================================
        async function initApp() {
            try {
                setLogLevel('debug');
                
                // 1. Inicializar la App de Firebase
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 2. Realizar la Autenticación
                let userCredential;
                
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token !== "") {
                    // Intentar con el token de Canvas
                    userCredential = await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // Si no hay token, forzar la sesión anónima
                    userCredential = await signInAnonymously(auth);
                }
                
                // 3. Definir el usuario después de una autenticación exitosa
                currentUser = userCredential.user;
                
                // 4. Cargar la UI y los datos
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                
                const userIdDisplay = document.getElementById('user-id-display');
                if (userIdDisplay) userIdDisplay.innerText = `ID de Usuario: ${currentUser.uid}`;
                
                // Cargar los datos (solo después de que el usuario esté listo)
                loadUserWatches();
                loadCommunityWatches();
                
            } catch (error) {
                // Mostrar un error claro si la inicialización falla
                console.error("Error CRÍTICO de Inicialización (Final):", error);
                
                // Mostrar un mensaje grande en la UI con el error exacto
                const loadingScreen = document.getElementById('loading-screen');
                const loadingText = document.getElementById('loading-text');

                if (loadingScreen) {
                    loadingScreen.classList.remove('hidden');
                    loadingScreen.style.backgroundColor = '#cc2222'; // Fondo de error rojo
                }
                if (loadingText) loadingText.innerText = `FALLO CRÍTICO: ${error.message}. Revise su configuración de Firebase y las Claves.`;
            }
        }

        window.onload = initApp;

        // =================================================================
        // === FUNCIONES DE UTILIDAD (Modal) ===============================
        // =================================================================

        /**
         * Muestra una ventana modal de alerta o confirmación.
         * @param {string} title - Título del modal.
         * @param {string} msg - Mensaje HTML del modal.
         * @param {boolean} isConfirmable - Si es true, añade botón de confirmar.
         * @param {function} callback - Función a ejecutar si se confirma.
         */
        function showModal(title, msg, isConfirmable = false, callback = null) {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMsg = document.getElementById('modal-msg');
            const actionsDiv = document.getElementById('modal-actions');
            const closeBtn = document.getElementById('modal-close-btn');

            modalTitle.innerText = title;
            modalMsg.innerHTML = msg;
            
            // Limpiar acciones previas (excepto el botón de cerrar)
            const confirmBtn = document.getElementById('modal-confirm-btn');
            if (confirmBtn) confirmBtn.remove();
            closeBtn.classList.remove('hidden'); // Asegurarse de que el botón de cerrar esté visible

            if (isConfirmable && callback) {
                const newConfirmBtn = document.createElement('button');
                newConfirmBtn.id = 'modal-confirm-btn';
                newConfirmBtn.className = 'btn-primary px-4 py-2 rounded-lg text-sm font-semibold';
                newConfirmBtn.innerText = 'Confirmar';
                newConfirmBtn.onclick = () => {
                    callback();
                    modal.classList.add('hidden');
                };
                actionsDiv.insertBefore(newConfirmBtn, closeBtn);
            }

            modal.classList.remove('hidden');
        }

        // =================================================================
        // === LÓGICA DE LA INTERFAZ Y FIREBASE ============================
        // =================================================================

        let activeTab = 'my-list';

        function switchTab(tab) {
            document.getElementById('my-list-content').classList.add('hidden');
            document.getElementById('community-content').classList.add('hidden');
            document.getElementById('tab-my-list').classList.remove('tab-active');
            document.getElementById('tab-community').classList.remove('tab-active');

            document.getElementById(`${tab}-content`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).classList.add('tab-active');
            activeTab = tab;
        }

        // --- Funciones de Renderizado ---

        function renderWatchItem(item, containerId, isCommunity = false) {
            const container = document.getElementById(containerId);
            const existingCard = document.getElementById(`watch-card-${item.id}`);

            const cardHtml = `
                <div id="watch-card-${item.id}" class="card p-5 shadow-xl flex flex-col justify-between" data-id="${item.id}">
                    <div>
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-bold text-ff6b6b">${item.title}</h3>
                            <span class="text-xs px-2 py-1 rounded-full ${item.type === 'movie' ? 'bg-indigo-500' : 'bg-green-500'} font-semibold">${item.type === 'movie' ? 'PELÍCULA' : 'SERIE'}</span>
                        </div>
                        <p class="text-sm text-gray-400 mb-3">ID Usuario: <span class="text-xs text-gray-500">${item.userId}</span></p>
                        <p class="text-lg font-medium mb-3">Estado: 
                            <span class="status-display" data-status="${item.status}">${item.status}</span>
                        </p>
                        ${!isCommunity ? `<p class="text-sm text-gray-500">Última actualización: ${new Date(item.updatedAt).toLocaleDateString()}</p>` : ''}
                    </div>
                    
                    <div class="mt-4 flex flex-col gap-2">
                        ${!isCommunity ? `
                            <select id="status-select-${item.id}" class="input-field p-2 rounded-lg text-sm" 
                                onchange="updateWatchStatus('${item.id}', this.value)">
                                <option value="Pendiente" ${item.status === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                                <option value="Viendo" ${item.status === 'Viendo' ? 'selected' : ''}>Viendo</option>
                                <option value="Completado" ${item.status === 'Completado' ? 'selected' : ''}>Completado</option>
                            </select>
                            <div class="flex gap-2">
                                <button onclick="shareWatchItem('${item.id}')" class="btn-secondary flex-1 p-2 rounded-lg text-sm">Compartir</button>
                                <button onclick="deleteWatchItem('${item.id}', '${item.title}')" class="bg-red-600 hover:bg-red-700 text-white flex-1 p-2 rounded-lg text-sm">Eliminar</button>
                            </div>
                        ` : `
                            <p class="text-sm text-gray-400 mt-2">Compartido por otro usuario.</p>
                        `}
                    </div>
                </div>
            `;

            if (existingCard) {
                // Actualizar el contenido si ya existe (para reflejar el nuevo estado)
                existingCard.outerHTML = cardHtml;
            } else {
                // Insertar al inicio de la lista
                container.insertAdjacentHTML('afterbegin', cardHtml);
            }
        }

        // --- Funciones de Firestore ---

        function getPrivateCollectionRef() {
            if (!currentUser) throw new Error("Usuario no autenticado para colección privada.");
            const userId = currentUser.uid;
            // Path: /artifacts/{appId}/users/{userId}/myWatches
            return collection(db, `artifacts/${__app_id}/users/${userId}/myWatches`);
        }

        function getCommunityCollectionRef() {
            // Path: /artifacts/{appId}/public/data/communityWatches
            return collection(db, `artifacts/${__app_id}/public/data/communityWatches`);
        }

        /**
         * Añade un nuevo elemento a la lista personal del usuario.
         */
        async function addWatchItem() {
            const titleInput = document.getElementById('title-input');
            const typeSelect = document.getElementById('type-select');
            const title = titleInput.value.trim();
            const type = typeSelect.value;

            if (!title) {
                showModal("Error de Entrada", "El título no puede estar vacío.", false);
                return;
            }
            if (!currentUser) {
                showModal("Error de Sesión", "La sesión de usuario no está activa.", false);
                return;
            }

            try {
                const newItem = {
                    title: title,
                    type: type, // 'movie' o 'series'
                    status: 'Pendiente', // 'Pendiente', 'Viendo', 'Completado'
                    userId: currentUser.uid,
                    createdAt: Date.now(),
                    updatedAt: Date.now()
                };

                await addDoc(getPrivateCollectionRef(), newItem);
                
                titleInput.value = '';
                showModal("Éxito", `"${title}" ha sido añadido a tu lista.`, false);
            } catch (e) {
                console.error("Error al añadir ítem:", e);
                showModal("Error de Firestore", `No se pudo añadir el ítem: ${e.message}`, false);
            }
        }

        /**
         * Actualiza el estado de un elemento en la lista personal.
         */
        window.updateWatchStatus = async function(id, newStatus) {
            try {
                const itemRef = doc(getPrivateCollectionRef(), id);
                await updateDoc(itemRef, {
                    status: newStatus,
                    updatedAt: Date.now()
                });
            } catch (e) {
                console.error("Error al actualizar estado:", e);
                showModal("Error de Firestore", `No se pudo actualizar el estado: ${e.message}`, false);
            }
        }

        /**
         * Elimina un elemento de la lista personal.
         */
        window.deleteWatchItem = function(id, title) {
            showModal("Confirmar Eliminación", 
                      `¿Estás seguro de que quieres eliminar "${title}" de tu lista?`, 
                      true, 
                      async () => {
                try {
                    const itemRef = doc(getPrivateCollectionRef(), id);
                    await deleteDoc(itemRef);
                    showModal("Eliminado", `"${title}" ha sido eliminado.`, false);
                } catch (e) {
                    console.error("Error al eliminar ítem:", e);
                    showModal("Error de Firestore", `No se pudo eliminar el ítem: ${e.message}`, false);
                }
            });
        }
        
        /**
         * Comparte un elemento de la lista personal a la lista de la comunidad.
         */
        window.shareWatchItem = async function(id) {
            try {
                const privateItemRef = doc(getPrivateCollectionRef(), id);
                const itemSnap = await getDoc(privateItemRef);

                if (!itemSnap.exists()) {
                    showModal("Error", "Ítem no encontrado en tu lista.", false);
                    return;
                }

                const itemData = itemSnap.data();
                
                // Crear una copia para la comunidad (usando el mismo ID de documento si ya existe)
                const communityItemRef = doc(getCommunityCollectionRef(), id);
                
                const sharedItem = {
                    title: itemData.title,
                    type: itemData.type,
                    status: itemData.status,
                    userId: currentUser.uid, // Esto asegura que la regla de seguridad funcione
                    sharedAt: Date.now() 
                };

                // Usar setDoc para crear o sobrescribir si ya estaba compartido
                await setDoc(communityItemRef, sharedItem, { merge: false });
                
                showModal("Compartido", `"${itemData.title}" ha sido compartido con la comunidad.`, false);
            } catch (e) {
                console.error("Error al compartir ítem:", e);
                showModal("Error de Firestore", `No se pudo compartir el ítem: ${e.message}`, false);
            }
        }

        // --- Listeners de Datos en Tiempo Real ---

        /**
         * Escucha los cambios en la lista personal del usuario.
         */
        function loadUserWatches() {
            if (!currentUser) return;

            const q = getPrivateCollectionRef();
            const container = document.getElementById('my-watches-list');
            container.innerHTML = '<p class="text-gray-500 col-span-2">Cargando tu lista...</p>';

            onSnapshot(q, (snapshot) => {
                // Limpiar el contenedor solo una vez si no hay documentos
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 col-span-2 text-center p-4">Tu lista está vacía. ¡Añade algo!</p>';
                    return;
                }
                
                // Mapear documentos y limpiar el contenedor antes de renderizar
                const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Limpiamos solo los placeholders de carga. La función renderItem actualizará/creará las tarjetas.
                container.querySelectorAll('p.text-gray-500').forEach(p => p.remove()); 

                const renderedIds = [];

                items.forEach(item => {
                    renderWatchItem(item, 'my-watches-list', false);
                    renderedIds.push(item.id);
                });

                // Eliminar elementos que ya no existen en el snapshot
                container.childNodes.forEach(node => {
                    if (node.nodeType === 1 && node.hasAttribute('data-id')) {
                        const id = node.getAttribute('data-id');
                        if (!renderedIds.includes(id)) {
                            node.remove();
                        }
                    }
                });

            }, (error) => {
                console.error("Error al escuchar lista personal:", error);
                container.innerHTML = `<p class="text-red-500 col-span-2">Error al cargar la lista: ${error.message}</p>`;
            });
        }

        /**
         * Escucha los cambios en la lista de la comunidad.
         */
        function loadCommunityWatches() {
            const q = getCommunityCollectionRef();
            const container = document.getElementById('community-watches-list');
            container.innerHTML = '<p class="text-gray-500 col-span-2">Cargando lista de la comunidad...</p>';
            
            onSnapshot(q, (snapshot) => {
                 if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-500 col-span-2 text-center p-4">Aún no hay títulos compartidos.</p>';
                    return;
                }

                const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                container.innerHTML = ''; // Limpiar y renderizar todo de nuevo

                items.forEach(item => {
                    renderWatchItem(item, 'community-watches-list', true);
                });

            }, (error) => {
                console.error("Error al escuchar lista comunitaria:", error);
                container.innerHTML = `<p class="text-red-500 col-span-2">Error al cargar la comunidad: ${error.message}</p>`;
            });
        }
    </script>
</body>
</html>
