<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WatchNow - Plataforma de Coleccionistas</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuraci贸n para usar la fuente Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Configuraci贸n de color para el tema oscuro */
        :root {
            --bg-color: #121212; /* Fondo muy oscuro, casi negro */
            --card-bg: #1e1e1e; /* Fondo de tarjeta un poco m谩s claro */
            --text-color: #e0e0e0; /* Texto claro */
            --primary-btn: #1A73E8; /* Azul sobrio para acciones principales (LOGIN) */
            --secondary-btn: #424242; /* Gris para acciones secundarias */
            --google-btn: #4285F4; /* Azul de Google */
            --facebook-btn: #1877F2; /* Azul de Facebook */
            --input-border: #333333; /* Borde de input */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Estilos base para el bot贸n de login */
        #loginButton {
            background-color: var(--primary-btn);
            transition: background-color 0.2s, transform 0.1s;
        }

        #loginButton:hover {
            background-color: #1558b3; /* Tono m谩s oscuro al pasar el rat贸n */
        }

        #loginButton:active {
            transform: scale(0.98);
        }

        /* Estilos base para el bot贸n de crear cuenta */
        #createAccountButton {
            background-color: var(--secondary-btn);
            transition: background-color 0.2s, transform 0.1s;
        }

        #createAccountButton:hover {
            background-color: #505050; /* Tono m谩s claro al pasar el rat贸n */
        }

        #createAccountButton:active {
            transform: scale(0.98);
        }

        .auth-card {
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5); /* Sombra suave para el modo oscuro */
        }
        
        /* Estilo para el contenedor central */
        .container-center {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
    </style>
</head>
<body>

    <div id="app" class="container-center">

        <!-- Contenedor de Idioma (est谩tico para que los listeners no fallen) -->
        <div id="languageSelector" class="flex justify-center space-x-4 mb-4 mt-8 w-full max-w-sm">
            <a href="#" id="lang-es" data-lang="es" class="text-gray-200 hover:text-gray-400 text-lg">Espa帽ol</a>
            <span class="text-gray-600">|</span>
            <a href="#" id="lang-en" data-lang="en" class="text-gray-200 hover:text-gray-400 text-lg">English</a>
        </div>

        <!-- Contenido din谩mico (se carga la pantalla de login o la principal) -->
        <div id="content" class="w-full max-w-sm">
            <!-- Pantalla de Carga Inicial -->
            <div id="loadingScreen" class="text-center">
                <h1 class="text-3xl font-bold text-gray-200 mb-2">WatchNow</h1>
                <p class="text-sm text-gray-400 mb-8">Identificaci贸n, Comunidad y Cat谩logo de Relojes</p>
                <div class="animate-pulse text-xl text-gray-500">
                    Cargando aplicaci贸n...
                </div>
            </div>
            
            <!-- Aqu铆 se insertar谩 la pantalla de Login (por JS) -->
        </div>
    </div>

    <!-- Modals y Message Box -->
    <div id="messageBox" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div id="messageCard" class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <h3 id="messageTitle" class="text-xl font-bold mb-3 text-gray-900"></h3>
            <p id="messageBody" class="text-gray-700 mb-5"></p>
            <button onclick="closeMessageBox()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out w-full">Aceptar</button>
        </div>
    </div>

    <script type="module">
        // Importaciones de Firebase (necesarias para la conexi贸n)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Habilitar logs para ver el estado de Firebase en la consola (F12)
        setLogLevel('Debug');

        // --- Configuraci贸n Global de Canvas (OBLIGATORIA) ---
        // Estas variables se proporcionan autom谩ticamente en el entorno
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let currentLanguage = 'es'; // Estado global del idioma

        // --- Funciones de Utilidad de UI ---
        
        window.closeMessageBox = () => {
            document.getElementById('messageBox').classList.add('hidden');
            document.getElementById('messageBox').classList.remove('flex');
        };

        const showMessageBox = (title, body) => {
            document.getElementById('messageTitle').textContent = title;
            document.getElementById('messageBody').textContent = body;
            document.getElementById('messageBox').classList.remove('hidden');
            document.getElementById('messageBox').classList.add('flex');
        };

        const hideLoading = () => {
            const loading = document.getElementById('loadingScreen');
            if (loading) loading.classList.add('hidden');
        }

        const showLoading = () => {
            const loading = document.getElementById('loadingScreen');
            if (loading) loading.classList.remove('hidden');
        }

        // --- Funciones de Interacci贸n de Firestore ---

        const getPrivateCollectionPath = (collectionName) => {
            // Ruta obligatoria para datos privados del usuario
            return `/artifacts/${appId}/users/${userId}/${collectionName}`;
        }

        const getPublicCollectionPath = (collectionName) => {
            // Ruta obligatoria para datos p煤blicos o compartidos
            return `/artifacts/${appId}/public/data/${collectionName}`;
        }
        
        // Funci贸n para guardar un documento de ejemplo al iniciar sesi贸n
        const saveExampleData = async () => {
            if (!db || !userId) return;
            const docRef = doc(db, getPrivateCollectionPath('user_data'), 'profile');
            try {
                // Guarda la informaci贸n del usuario an贸nimo
                await setDoc(docRef, { 
                    username: 'AnonUser_' + userId.substring(0, 8),
                    lastLogin: new Date().toISOString()
                }, { merge: true });
                console.log("Datos de ejemplo guardados exitosamente.");
            } catch (error) {
                console.error("Error al guardar datos de ejemplo:", error);
            }
        };

        // --- L贸gica de Idioma ---

        const setLanguage = (lang) => {
            currentLanguage = lang;
            console.log(`Idioma cambiado a: ${currentLanguage}. (Simulaci贸n de cambio de UI).`);
            showMessageBox("Cambio de Idioma", `Se ha seleccionado el idioma: ${lang.toUpperCase()}. En una aplicaci贸n completa, la UI se traducir铆a ahora.`);
        }

        // --- Renderizado de Vistas ---

        const renderLoginScreen = () => {
            hideLoading();
            const contentDiv = document.getElementById('content');
            
            contentDiv.innerHTML = `
                <div class="auth-card bg-card-bg p-8 rounded-xl shadow-lg mt-8">
                    <h2 class="text-2xl font-semibold text-center mb-6 text-white">Ingresar a WatchNow</h2>
                    
                    <div class="space-y-4">
                        <input type="email" id="emailInput" placeholder="Correo Electr贸nico"
                               class="w-full px-4 py-3 bg-card-bg border border-input-border rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                               autocomplete="email">
                        
                        <input type="password" id="passwordInput" placeholder="Contrase帽a"
                               class="w-full px-4 py-3 bg-card-bg border border-input-border rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                               autocomplete="current-password">
                        
                        <!-- Bot贸n de Iniciar Sesi贸n -->
                        <button id="loginButton"
                                class="w-full text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150 ease-in-out mt-2">
                            Iniciar Sesi贸n
                        </button>

                        <!-- Bot贸n de Crear Cuenta -->
                        <button id="createAccountButton"
                                class="w-full text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                            Crear Cuenta
                        </button>
                    </div>

                    <div class="flex items-center my-6">
                        <div class="flex-grow border-t border-gray-600"></div>
                        <span class="flex-shrink mx-4 text-gray-500">-- o --</span>
                        <div class="flex-grow border-t border-gray-600"></div>
                    </div>

                    <div class="space-y-3">
                        <!-- Botones de terceros (Simulados) -->
                        <button id="googleButton" 
                                class="w-full bg-google-btn hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center transition duration-150 ease-in-out">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/4/4a/Logo_and_wordmark_of_Google_G_Suite.svg" alt="Google" class="w-5 h-5 mr-3 bg-white rounded-full">
                            Google
                        </button>
                        <button id="facebookButton"
                                class="w-full bg-facebook-btn hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center transition duration-150 ease-in-out">
                            <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M14.07,10.37h2.09l0.31-2.09h-2.4c-0.62,0-1.11-0.49-1.11-1.11v-1.42h3.42V3.41H12.9v1.94c-1.42,0-2.56,1.14-2.56,2.56v1.47h-2.09v2.09h2.09v6.52c0,0.61,0.5,1.11,1.11,1.11h3.42c0.61,0,1.11-0.5,1.11-1.11v-6.52h-2.09V10.37z"/>
                            </svg>
                            Facebook
                        </button>
                    </div>
                    
                    <button id="anonymousButton" class="w-full text-sm text-gray-500 hover:text-gray-400 mt-6 transition duration-150 ease-in-out">
                        Continuar como An贸nimo
                    </button>
                </div>
            `;
            
            // Asignar Event Listeners para la autenticaci贸n
            document.getElementById('loginButton').addEventListener('click', (e) => { e.preventDefault(); handleAuth('login'); });
            document.getElementById('createAccountButton').addEventListener('click', (e) => { e.preventDefault(); handleAuth('register'); });
            document.getElementById('anonymousButton').addEventListener('click', (e) => { e.preventDefault(); handleAnonymousLogin(); });
            document.getElementById('googleButton').addEventListener('click', (e) => { e.preventDefault(); handleAnonymousLogin(); });
            document.getElementById('facebookButton').addEventListener('click', (e) => { e.preventDefault(); handleAnonymousLogin(); });
        };
        
        const renderAppScreen = () => {
            hideLoading();
            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = `
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-200 mb-2">WatchNow</h1>
                    <p class="text-sm text-gray-400 mb-8">Identificaci贸n y Valoraci贸n de Relojes con IA</p>
                </div>

                <div class="bg-card-bg p-8 rounded-xl shadow-lg w-full max-w-sm text-center">
                    <div class="mb-6">
                        <p class="text-gray-400 mb-4">
                            隆Bienvenido, Usuario!
                            <br>
                            ID de Sesi贸n: <span class="text-sm font-mono text-blue-400">${userId || 'Cargando...'}</span>
                        </p>
                        <div class="text-4xl text-gray-500 mx-auto w-16 h-16 flex items-center justify-center bg-input-border rounded-full cursor-pointer hover:bg-gray-700 transition duration-150">
                            <span class="pointer-events-none"></span>
                        </div>
                        <p class="text-gray-400 mt-3">
                            Toca para seleccionar una imagen clara del reloj
                        </p>
                    </div>

                    <button id="analyzeButton"
                            class="w-full bg-primary-btn hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-150 ease-in-out">
                        Analizar y Buscar Historia
                    </button>
                    
                    <button id="logoutButton"
                            class="w-full mt-4 bg-secondary-btn hover:bg-gray-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-150 ease-in-out">
                        Cerrar Sesi贸n
                    </button>
                </div>
            `;
            
            document.getElementById('logoutButton').addEventListener('click', handleLogout);
            document.getElementById('analyzeButton').addEventListener('click', () => {
                showMessageBox("Funci贸n de IA", "Esta funci贸n usar铆a la API de Google Gemini para analizar la imagen del reloj y buscar su informaci贸n hist贸rica.");
            });
        };

        // --- L贸gica de Autenticaci贸n (Manejando Email/Password) ---

        const handleAuth = async (mode) => {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            
            if (!email || !password) {
                showMessageBox("Error de Validaci贸n", "Por favor, introduce un correo electr贸nico y una contrase帽a.");
                return;
            }

            try {
                if (mode === 'register') {
                    await createUserWithEmailAndPassword(auth, email, password);
                    showMessageBox("Registro Exitoso", "隆Tu cuenta ha sido creada y has iniciado sesi贸n!");
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    showMessageBox("Inicio de Sesi贸n Exitoso", "隆Bienvenido de vuelta!");
                }
            } catch (error) {
                console.error("Error de autenticaci贸n:", error);
                showMessageBox("Error de Autenticaci贸n", `No se pudo ${mode === 'register' ? 'crear la cuenta' : 'iniciar sesi贸n'}. Por favor, verifica tus credenciales. Mensaje: ${error.message}`);
            }
        };
        
        // L贸gica de Login An贸nimo (para el bot贸n "Continuar como An贸nimo")
        const handleAnonymousLogin = async () => {
            try {
                if (isAuthReady && userId) {
                     renderAppScreen();
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error al iniciar sesi贸n an贸nimamente:", error);
                showMessageBox("Error de Login", `No se pudo continuar como an贸nimo. Mensaje: ${error.message}`);
            }
        };

        const handleLogout = async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error al cerrar sesi贸n:", error);
                showMessageBox("Error de Cierre de Sesi贸n", `No se pudo cerrar la sesi贸n. Mensaje: ${error.message}`);
            }
        };


        // --- Inicializaci贸n de Firebase y Autenticaci贸n (Punto de Conexi贸n) ---

        const initializeAppAndAuth = async () => {
            // Asignar eventos de idioma (Ahora que son est谩ticos, se asignan aqu铆 una sola vez)
            document.getElementById('lang-es').addEventListener('click', (e) => { e.preventDefault(); setLanguage('es'); });
            document.getElementById('lang-en').addEventListener('click', (e) => { e.preventDefault(); setLanguage('en'); });
            
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                     // Si no hay configuraci贸n de Firebase, simulamos la conexi贸n
                    auth = { currentUser: null, signOut: () => console.log('Simulated signOut'), onAuthStateChanged: () => {} };
                    isAuthReady = true;
                    userId = 'SIMULADO';
                    renderLoginScreen();
                    showMessageBox("Advertencia", "Firebase no est谩 configurado. Usa 'Continuar como An贸nimo' para probar la navegaci贸n.");
                    return; 
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 1. Manejar el estado de autenticaci贸n: Esto redirige a la pantalla correcta
                onAuthStateChanged(auth, (user) => {
                    isAuthReady = true;
                    if (user) {
                        // Usuario autenticado (ej. login exitoso)
                        userId = user.uid;
                        console.log("Usuario autenticado. UID:", userId);
                        saveExampleData(); // Guarda datos iniciales
                        renderAppScreen();
                    } else {
                        // Usuario deslogueado (ej. logout)
                        userId = null;
                        console.log("Usuario deslogueado.");
                        renderLoginScreen();
                    }
                });

                // 2. Intentar autenticar con el token de Canvas o de forma an贸nima
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Autenticaci贸n con token de Canvas exitosa.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Autenticaci贸n an贸nima iniciada.");
                }

            } catch (error) {
                console.error("Error Cr铆tico de Configuraci贸n/Inicializaci贸n:", error);
                const contentDiv = document.getElementById('content');
                contentDiv.innerHTML = `
                    <div class="bg-red-700 p-6 rounded-xl shadow-lg mt-8 text-white text-center">
                        <h2 class="text-xl font-bold mb-3">Error de Conexi贸n Cr铆tico</h2>
                        <p class="mb-4">
                            La aplicaci贸n no pudo inicializar Firebase.
                            Mensaje: ${error.message}
                        </p>
                    </div>
                `;
            }
        };

        // Iniciar la aplicaci贸n al cargar la ventana
        window.onload = initializeAppAndAuth;
        
    </script>
</body>
</html>
